{# NOME DO ARQUIVO: templates/admin_detalhe_licenca.html #}
{% extends 'admin_base.html' %}

{% block title %}Análise de Licença - {{ licenca.protocolo_licencas }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Análise de Solicitação de Licença</h1>
        {# O botão Voltar agora é inteligente e usa a variável 'origin' #}
        {% if origin == 'historico' %}
            <a href="{{ url_for('admin_historico_licencas') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar para o Histórico
            </a>
        {% else %}
            <a href="{{ url_for('admin_analisar_licencas') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar para Análise
            </a>
        {% endif %}
    </div>

    <!-- Card de Ações Administrativas -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Ações Administrativas</h6>
        </div>
        <div class="card-body">
            <form action="{{ url_for('admin_atualizar_status_licenca', licenca_id=licenca.id) }}" method="POST">
                {# ... (seu formulário de ações completo vai aqui) ... #}
                 <div class="row align-items-center mb-3">
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Status atual:</strong>
                            <span class="badge {% if licenca.status == 'Aprovado' %} bg-success {% elif licenca.status in ['Reprovado', 'Cancelado'] %} bg-danger {% elif licenca.status == 'Pendente de Correção' %} bg-warning text-dark {% else %} bg-secondary {% endif %}">
                                {{ licenca.status }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-8 text-end">
                        {% if licenca.status == 'Aprovado' and licenca.alvara_pdf_path %}
                            <a href="{{ url_for('download_alvara', filename=licenca.alvara_pdf_path) }}" class="btn btn-success" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>Baixar Alvará Emitido
                            </a>
                        {% endif %}
                    </div>
                </div>
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="status-select" class="form-label">Mudar status para:</label>
                        <select name="novo_status" id="status-select" class="form-select">
                            <option value="Pendente" {% if licenca.status == 'Pendente' %}selected{% endif %}>Pendente</option>
                            <option value="Aprovado" {% if licenca.status == 'Aprovado' %}selected{% endif %}>Aprovado</option>
                            <option value="Pendente de Correção" {% if licenca.status == 'Pendente de Correção' %}selected{% endif %}>Pendente de Correção</option>
                            <option value="Reprovado" {% if licenca.status == 'Reprovado' %}selected{% endif %}>Reprovado</option>
                            <option value="Cancelado" {% if licenca.status == 'Cancelado' %}selected{% endif %}>Cancelado</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="justificativa-input" class="form-label">Justificativa <span id="justificativa-required-star" class="text-danger" style="display: none;">*</span></label>
                        <input type="text" name="justificativa" id="justificativa-input" class="form-control" value="{{ licenca.justificativa_status or '' }}">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-save me-2"></i>Salvar Alteração</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Card de Dados da Empresa (CORRIGIDO) -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Dados da Empresa</h6>
        </div>
        <div class="card-body">
            {% if licenca.estabelecimento %}
            <dl class="row">
                <dt class="col-sm-3">Razão Social:</dt>
                <dd class="col-sm-9">{{ licenca.estabelecimento.razao_social }}</dd>

                <dt class="col-sm-3">Nome Fantasia:</dt>
                <dd class="col-sm-9">{{ licenca.estabelecimento.nome_fantasia or 'Não informado' }}</dd>

                <dt class="col-sm-3">CNPJ:</dt>
                <dd class="col-sm-9">{{ licenca.estabelecimento.cnpj }}</dd>

                <dt class="col-sm-3">Situação Cadastral:</dt>
                <dd class="col-sm-9">{{ licenca.estabelecimento.situacao_cadastral }}</dd>

                <dt class="col-sm-3">Responsável Jurídico:</dt>
                <dd class="col-sm-9">{{ licenca.estabelecimento.responsavel_juridico_nome }}</dd>

                <hr class="my-2">

                <dt class="col-sm-3">CNAE Primário:</dt>
                <dd class="col-sm-9">{{ licenca.estabelecimento.cnae_principal }}</dd>

                <dt class="col-sm-3">CNAEs Secundários:</dt>
                <dd class="col-sm-9" style="white-space: pre-wrap;">{{ licenca.estabelecimento.cnae_secundario or 'Não informado' }}</dd>
                
                <hr class="my-2">

                <dt class="col-sm-3">Horário de Funcionamento:</dt>
                <dd class="col-sm-9">{{ licenca.estabelecimento.horario_segunda_feira or 'Não informado' }}</dd>
            </dl>
            {% else %}
            <p class="text-danger">Não foi possível carregar os dados da empresa associada.</p>
            {% endif %}
        </div>
    </div>

    <!-- Card de Respostas do Formulário (ATUALIZADO) -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Respostas do Formulário (Protocolo: {{ licenca.protocolo_licencas }})</h6>
        </div>
        <div class="card-body">
            <dl class="row">
                <!-- Seção Geral -->
                <dt class="col-sm-4">Tipo de Atividade:</dt>
                <dd class="col-sm-8">{{ licenca.tipo_atividade or 'Não informado' }}</dd>
                <dt class="col-sm-4">Possui Local Físico:</dt>
                <dd class="col-sm-8">{{ 'Sim' if licenca.possui_local_fisico == 'sim' else 'Não' }}</dd>
                <dt class="col-sm-4">Atividade Principal Descrita:</dt>
                <dd class="col-sm-8">{{ licenca.descricao_atividade or 'Não informado' }}</dd>
                
                <hr class="my-3">
                
                <!-- Seção Responsável Técnico (RT) -->
                <dt class="col-sm-4">Necessita Responsável Técnico (RT)?</dt>
                <dd class="col-sm-8">{{ 'Sim' if licenca.necessita_rt == 'sim' else 'Não' }}</dd>
                {% if licenca.necessita_rt == 'sim' %}
                    <dt class="col-sm-4 text-end">Nome do RT:</dt>
                    <dd class="col-sm-8">{{ licenca.rt_nome or 'Não preenchido' }}</dd>
                    <dt class="col-sm-4 text-end">CPF do RT:</dt>
                    <dd class="col-sm-8">{{ licenca.rt_cpf or 'Não preenchido' }}</dd>
                    <dt class="col-sm-4 text-end">Contato do RT:</dt>
                    <dd class="col-sm-8">{{ licenca.rt_contato or 'Não preenchido' }}</dd>
                    <dt class="col-sm-4 text-end">Conselho:</dt>
                    <dd class="col-sm-8">{{ licenca.rt_conselho or 'N/A' }}: {{ licenca.rt_numero_conselho or 'N/A' }}</dd>
                {% endif %}
                
                <hr class="my-3">
                
                <!-- Seção Medicamentos -->
                <dt class="col-sm-4">Vende Medicamentos Controlados?</dt>
                <dd class="col-sm-8">{{ 'Sim' if licenca.vende_controlados == 'sim' else 'Não' }}</dd>
                {% if licenca.vende_controlados == 'sim' %}
                    <dt class="col-sm-4 text-end">Nº da Autorização (AFE):</dt>
                    <dd class="col-sm-8">{{ licenca.afe_numero or 'Não informado' }}</dd>
                {% endif %}

                <!-- Seção Veterinária -->
                <dt class="col-sm-4">Vende Produtos Veterinários?</dt>
                <dd class="col-sm-8">{{ 'Sim' if licenca.vende_animais == 'sim' else 'Não' }}</dd>
                {% if licenca.vende_animais == 'sim' %}
                    <dt class="col-sm-4 text-end">Nome do RT Veterinário:</dt>
                    <dd class="col-sm-8">{{ licenca.rt_vet_nome or 'Não preenchido' }}</dd>
                {% endif %}

                <hr class="my-3">
                
                <!-- Seção Dedetização -->
                <dt class="col-sm-4">Realizou Dedetização?</dt>
                <dd class="col-sm-8">{{ 'Sim' if licenca.realizou_dedetizacao == 'sim' else 'Não' }}</dd>
                {% if licenca.realizou_dedetizacao == 'sim' %}
                    <dt class="col-sm-4 text-end">Data da Dedetização:</dt>
                    <dd class="col-sm-8">{{ licenca.data_dedetizacao or 'Não informada' }}</dd>
                {% endif %}
            </dl>
        </div>
    </div>
    
    <!-- Card de Documentos Anexados (ATUALIZADO) -->
    <div class="card shadow mb-4">
         <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Documentos Anexados</h6>
        </div>
        <div class="card-body p-0">
            <ul class="list-group list-group-flush">
                {% set anexo_encontrado = false %}
                {% if licenca.rt_declaracao_path %}
                    {% set anexo_encontrado = true %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Declaração do Responsável Técnico (RT)
                        <a href="{{ url_for('download_alvara', nome_arquivo=licenca.rt_declaracao_path) }}" class="btn btn-sm btn-outline-secondary" target="_blank"><i class="fas fa-download me-1"></i> Ver Anexo</a>
                    </li>
                {% endif %}
                {% if licenca.rt_vet_declaracao_path %}
                    {% set anexo_encontrado = true %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Declaração do RT Veterinário
                        <a href="{{ url_for('download_alvara', nome_arquivo=licenca.rt_vet_declaracao_path) }}" class="btn btn-sm btn-outline-secondary" target="_blank"><i class="fas fa-download me-1"></i> Ver Anexo</a>
                    </li>
                {% endif %}
                {% if licenca.afe_path %}
                    {% set anexo_encontrado = true %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Autorização de Funcionamento (AFE)
                        <a href="{{ url_for('download_alvara', nome_arquivo=licenca.afe_path) }}" class="btn btn-sm btn-outline-secondary" target="_blank"><i class="fas fa-download me-1"></i> Ver Anexo</a>
                    </li>
                {% endif %}
                {% if licenca.certificado_dedetizacao_path %}
                    {% set anexo_encontrado = true %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Certificado de Dedetização
                        <a href="{{ url_for('download_alvara', nome_arquivo=licenca.certificado_dedetizacao_path) }}" class="btn btn-sm btn-outline-secondary" target="_blank"><i class="fas fa-download me-1"></i> Ver Anexo</a>
                    </li>
                {% endif %}

                {% if not anexo_encontrado %}
                    <li class="list-group-item">Nenhum documento foi anexado para esta solicitação.</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}
