{% extends 'admin_base.html' %}
{% block title %}Analisar Licença de Autônomo{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Análise de Licença - Autônomo</h1>
        <a href="{{ url_for('admin_analisar_licencas_autonomos') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para a Lista
        </a>
    </div>

    <!-- Ações Administrativas -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Ações Administrativas</h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin_atualizar_status_licenca_autonomo', licenca_id=licenca.id) }}">
                <p class="mb-2"><strong>Status atual:</strong> 
                    <span class="badge 
                        {% if licenca.status == 'Aprovado' %} bg-success
                        {% elif licenca.status == 'Reprovado' %} bg-danger
                        {% else %} bg-warning text-dark
                        {% endif %}">
                        {{ licenca.status }}
                    </span>
                </p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="novo_status" class="form-label">Mudar status para:</label>
                        <select class="form-select" name="novo_status" id="novo_status">
                            <option value="Aprovado">Aprovado</option>
                            <option value="Reprovado">Reprovado</option>
                            <option value="Pendente com Observação">Pendente com Observação</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="data_validade" class="form-label">Data de Validade da Licença:</label>
                        <input type="date" class="form-control" name="data_validade" id="data_validade" value="{{ licenca.data_validade.strftime('%Y-%m-%d') if licenca.data_validade else (licenca.ano_exercicio ~ '-12-31' if licenca.ano_exercicio else '') }}">
                    </div>
                    
                    <!-- :: INÍCIO DA ALTERAÇÃO :: Campo de Observações adicionado -->
                    <div class="col-12">
                        <label for="observacoes" id="label_observacoes" class="form-label">Observações / Justificativa (visível para o cidadão):</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3">{{ licenca.observacoes or '' }}</textarea>
                    </div>
                    <!-- :: FIM DA ALTERAÇÃO :: -->
                </div>

                <div class="mt-4 d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar Alterações
                    </button>
                    <a href="{{ url_for('admin_imprimir_ficha_licenca_autonomo', licenca_id=licenca.id) }}" class="btn btn-outline-info" target="_blank">
                        <i class="fas fa-print me-1"></i> Imprimir Ficha
                    </a>
                    {% if licenca.status == 'Aprovado' and licenca.alvara_pdf_path %}
                    <a href="{{ url_for('admin_download_alvara_autonomo', licenca_id=licenca.id) }}" class="btn btn-success">
                        <i class="fas fa-check-circle me-1"></i> Imprimir Alvará
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- :: INÍCIO DA ALTERAÇÃO :: Card de Histórico de Pendências adicionado -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Histórico de Pendências e Respostas</h6>
        </div>
        <div class="card-body">
            {% if licenca.observacoes %}
                <h6>Histórico de Observações / Respostas:</h6>
                <pre class="p-3 bg-light border rounded" style="white-space: pre-wrap;"><code>{{ licenca.observacoes }}</code></pre>
            {% endif %}

            {% if licenca.anexos_pendencia %}
                <h6 class="mt-4">Documentos Anexados para Resolução de Pendências:</h6>
                <ul class="list-group">
                    {% for anexo in licenca.anexos_pendencia %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-paperclip me-2"></i>
                            {{ anexo.nome_original }}
                            <small class="text-muted d-block">Enviado em: {{ anexo.data_envio }}</small>
                        </span>
                        <a href="{{ url_for('static', filename='uploads/' + anexo.caminho_salvo.replace('\\', '/')) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="fas fa-eye me-1"></i> Visualizar
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                {% if not licenca.observacoes %}
                     <p class="text-muted">Nenhum histórico de pendências para esta licença.</p>
                {% else %}
                     <p class="text-muted mt-3">Nenhum documento de pendência foi enviado pelo cidadão.</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    <!-- :: FIM DA ALTERAÇÃO :: -->

    <!-- 1. Dados Pessoais do Autônomo -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">1. Dados Pessoais do Autônomo</h6>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Protocolo:</dt><dd class="col-sm-9">{{ licenca.protocolo }}</dd>
                <dt class="col-sm-3">Nome Completo:</dt><dd class="col-sm-9">{{ licenca.autonomo.nome_completo }}</dd>
                <dt class="col-sm-3">CPF:</dt><dd class="col-sm-9">{{ licenca.autonomo.cpf }}</dd>
                <dt class="col-sm-3">RG:</dt><dd class="col-sm-9">{{ licenca.autonomo.rg }}</dd>
                <dt class="col-sm-3">Data de Nascimento:</dt><dd class="col-sm-9">{{ licenca.autonomo.data_nascimento.strftime('%d/%m/%Y') if licenca.autonomo.data_nascimento }}</dd>
                <dt class="col-sm-3">Nacionalidade:</dt><dd class="col-sm-9">{{ licenca.nacionalidade or 'Não informado' }}</dd>
                <dt class="col-sm-3">Estado Civil:</dt><dd class="col-sm-9">{{ licenca.estado_civil or 'Não informado' }}</dd>
                <dt class="col-sm-3">Profissão:</dt><dd class="col-sm-9">{{ licenca.autonomo.profissao }}</dd>
                <dt class="col-sm-3">Contato:</dt><dd class="col-sm-9">{{ licenca.autonomo.telefone_celular }} / {{ licenca.autonomo.email }}</dd>
            </dl>
        </div>
    </div>
    
    <!-- 2. Endereço Residencial -->
    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">2. Endereço Residencial</h6></div>
        <div class="card-body">
            <p>{{ licenca.autonomo.endereco_atendimento or 'Não informado' }}</p>
        </div>
    </div>

    <!-- 3. Local de Atuação -->
    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">3. Local de Atuação</h6></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Endereço:</dt><dd class="col-sm-9">{{ licenca.local_atuacao_endereco or 'Não informado' }}</dd>
                <dt class="col-sm-3">Tipo de Local:</dt><dd class="col-sm-9">{{ licenca.local_atuacao_tipo or 'Não informado' }}</dd>
                <dt class="col-sm-3">Referência:</dt><dd class="col-sm-9">{{ licenca.local_atuacao_referencia or 'Não informado' }}</dd>
            </dl>
        </div>
    </div>

    <!-- 4. Dados da Atividade Exercida -->
    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">4. Dados da Atividade Exercida</h6></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-4">Descrição da Atividade:</dt><dd class="col-sm-8">{{ licenca.descricao_atividade or 'Não informado' }}</dd>
                <dt class="col-sm-4">Possui RT:</dt><dd class="col-sm-8">{{ 'Sim' if licenca.possui_rt == 'sim' else 'Não' }}</dd>
                {% if licenca.possui_rt == 'sim' %}
                    <dt class="col-sm-4 text-muted ps-5">Nome do RT:</dt><dd class="col-sm-8 text-muted">{{ licenca.rt_nome or 'Não informado' }}</dd>
                    <dt class="col-sm-4 text-muted ps-5">CPF do RT:</dt><dd class="col-sm-8 text-muted">{{ licenca.rt_cpf or 'Não informado' }}</dd>
                    <dt class="col-sm-4 text-muted ps-5">Conselho:</dt><dd class="col-sm-8 text-muted">{{ licenca.rt_conselho or 'Não informado' }}</dd>
                {% endif %}
                <dt class="col-sm-4">Utiliza Perfurocortantes:</dt><dd class="col-sm-8">{{ 'Sim' if licenca.usa_perfuro == 'sim' else 'Não' }}</dd>
                <dt class="col-sm-4">Realiza Procedimentos Invasivos:</dt><dd class="col-sm-8">{{ 'Sim' if licenca.faz_invasivo == 'sim' else 'Não' }}</dd>
                {% if licenca.faz_invasivo == 'sim' %}
                    <dt class="col-sm-4 text-muted ps-5">Descrição dos Procedimentos:</dt><dd class="col-sm-8 text-muted">{{ licenca.invasivo_descricao or 'Não informado' }}</dd>
                {% endif %}
            </dl>
        </div>
    </div>
    
    <!-- 5. Documentos Anexados à LICENÇA -->
    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">5. Documentos Anexados</h6></div>
        <div class="card-body">
            <ul class="list-group list-group-flush">
                {% set doc_map = {
                    "Alvará de Funcionamento (Prefeitura)": licenca.doc_alvara_funcionamento_path,
                    "Documento de Identidade": licenca.doc_identidade_path,
                    "CPF": licenca.doc_cpf_path,
                    "Comprovante de Residência": licenca.doc_residencia_path,
                    "Certificado do Curso": licenca.doc_formacao_path,
                    "Comprovante de Dedetização": licenca.doc_dedetizacao_path,
                    "Declaração de RT": licenca.rt_declaracao_path
                } %}
                
                {% set has_docs = false %}
                {% for label, path in doc_map.items() %}
                    {% if path %}
                        {% set has_docs = true %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ label }}
                            <a href="{{ url_for('static', filename='uploads/' + path.replace('\\', '/')) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="fas fa-eye me-1"></i> Visualizar
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if not has_docs %}
                    <li class="list-group-item">Nenhum documento foi anexado a esta solicitação de licença.</li>
                {% endif %}
            </ul>
        </div>
    </div>

</div>

<!-- :: INÍCIO DA ALTERAÇÃO :: Script para campo obrigatório -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('novo_status');
    const observacoesTextarea = document.getElementById('observacoes');
    const observacoesLabel = document.getElementById('label_observacoes');
    const originalLabel = observacoesLabel.innerHTML;

    function toggleObservacoesRequired() {
        const selectedValue = statusSelect.value;
        if (selectedValue === 'Reprovado' || selectedValue === 'Pendente com Observação') {
            observacoesTextarea.required = true;
            observacoesLabel.innerHTML = originalLabel + ' <span class="text-danger">*</span>';
        } else {
            observacoesTextarea.required = false;
            observacoesLabel.innerHTML = originalLabel;
        }
    }

    // Adiciona o listener para o evento de mudança
    statusSelect.addEventListener('change', toggleObservacoesRequired);

    // Executa a função uma vez no carregamento da página para definir o estado inicial
    toggleObservacoesRequired();
});
</script>
<!-- :: FIM DA ALTERAÇÃO :: -->

{% endblock %}
