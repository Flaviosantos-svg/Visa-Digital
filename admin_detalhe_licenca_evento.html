{% extends 'admin_base.html' %}
{% block title %}Analisar Licença de Evento{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Análise de Licença - Evento</h1>
        <a href="{{ url_for('admin_listar_licencas_eventos') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para a Lista
        </a>
    </div>

    <!-- Ações Administrativas -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Ações Administrativas</h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin_atualizar_status_licenca_evento', evento_id=licenca.id) }}">
                <p class="mb-2"><strong>Status atual:</strong> 
                    <span class="badge 
                        {% if licenca.status == 'Aprovado' %} bg-success
                        {% elif licenca.status == 'Reprovado' %} bg-danger
                        {% else %} bg-warning text-dark
                        {% endif %}">
                        {{ licenca.status }}
                    </span>
                </p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="novo_status" class="form-label">Mudar status para:</label>
                        <select class="form-select" name="novo_status" id="novo_status">
                            <option value="Aprovado">Aprovado</option>
                            <option value="Reprovado">Reprovado</option>
                            <option value="Pendente com Observação">Pendente com Observação</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="data_validade" class="form-label">Data de Validade da Licença</label>
                        <input type="date" class="form-control" name="data_validade" id="data_validade" value="{{ licenca.data_validade.strftime('%Y-%m-%d') if licenca.data_validade else licenca.data_fim.strftime('%Y-%m-%d') if licenca.data_fim else '' }}">
                    </div>
                    
                    <!-- :: INÍCIO DA ALTERAÇÃO :: Campo de Observações adicionado -->
                    <div class="col-12">
                        <label for="observacoes" id="label_observacoes" class="form-label">Observações / Justificativa (visível para o cidadão):</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>
                    <!-- :: FIM DA ALTERAÇÃO :: -->
                </div>
                <div class="mt-4 d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar Alterações
                    </button>
                    <a href="{{ url_for('admin_imprimir_ficha_licenca_evento', licenca_id=licenca.id) }}" class="btn btn-outline-info" target="_blank">
                        <i class="fas fa-print me-1"></i> Imprimir Ficha
                    </a>
                    {% if licenca.status == 'Aprovado' and licenca.alvara_pdf_path %}
                    <a href="{{ url_for('download_alvara_evento', filename=licenca.alvara_pdf_path) }}" class="btn btn-success">
                        <i class="fas fa-check-circle me-1"></i> Imprimir Alvará
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- :: INÍCIO DA ALTERAÇÃO :: Card de Histórico de Pendências adicionado -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Histórico de Pendências e Respostas</h6>
        </div>
        <div class="card-body">
            {% if licenca.observacoes %}
                <h6>Histórico de Observações / Respostas:</h6>
                <pre class="p-3 bg-light border rounded" style="white-space: pre-wrap;"><code>{{ licenca.observacoes }}</code></pre>
            {% endif %}

            {% if licenca.anexos_pendencia %}
                <h6 class="mt-4">Documentos Anexados para Resolução de Pendências:</h6>
                <ul class="list-group">
                    {% for anexo in licenca.anexos_pendencia %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-paperclip me-2"></i>
                            {{ anexo.nome_original }}
                            <small class="text-muted d-block">Enviado em: {{ anexo.data_envio }}</small>
                        </span>
                        <a href="{{ url_for('static', filename='uploads/' + anexo.caminho_salvo.replace('\\', '/')) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="fas fa-eye me-1"></i> Visualizar
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                {% if not licenca.observacoes %}
                     <p class="text-muted">Nenhum histórico de pendências para esta licença.</p>
                {% else %}
                     <p class="text-muted mt-3">Nenhum documento de pendência foi enviado pelo cidadão.</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    <!-- :: FIM DA ALTERAÇÃO :: -->

    <!-- 1. DADOS DO SOLICITANTE -->
    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">1. Dados do Solicitante</h6></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Protocolo:</dt><dd class="col-sm-9">{{ licenca.protocolo }}</dd>
                <dt class="col-sm-3">Nome / Razão Social:</dt><dd class="col-sm-9">{{ licenca.solicitante_nome }}</dd>
                <dt class="col-sm-3">CPF / CNPJ:</dt><dd class="col-sm-9">{{ licenca.solicitante_cpf_cnpj }}</dd>
                <dt class="col-sm-3">RG:</dt><dd class="col-sm-9">{{ licenca.solicitante_rg or 'Não informado' }}</dd>
                <dt class="col-sm-3">Telefone:</dt><dd class="col-sm-9">{{ licenca.solicitante_telefone or 'Não informado' }}</dd>
                <dt class="col-sm-3">E-mail:</dt><dd class="col-sm-9">{{ licenca.solicitante_email or 'Não informado' }}</dd>
                <dt class="col-sm-3">Endereço:</dt><dd class="col-sm-9">{{ licenca.solicitante_endereco or 'Não informado' }}</dd>
            </dl>
        </div>
    </div>
    
    <!-- 2. DADOS DO EVENTO -->
    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">2. Dados do Evento</h6></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Nome do Evento:</dt><dd class="col-sm-9">{{ licenca.nome_evento }}</dd>
                <dt class="col-sm-3">Tipo de Evento:</dt><dd class="col-sm-9">{{ licenca.tipos_evento or 'Não informado' }}</dd>
                <dt class="col-sm-3">Local:</dt><dd class="col-sm-9">{{ licenca.local_evento }}</dd>
                <dt class="col-sm-3">Período:</dt><dd class="col-sm-9">{{ licenca.data_inicio.strftime('%d/%m/%Y') if licenca.data_inicio }} a {{ licenca.data_fim.strftime('%d/%m/%Y') if licenca.data_fim }}</dd>
                <dt class="col-sm-3">Horário:</dt><dd class="col-sm-9">{{ licenca.horario or 'Não informado' }}</dd>
            </dl>
        </div>
    </div>

    <!-- 3. ESTRUTURA DO EVENTO -->
    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">3. Estrutura do Evento</h6></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-6">Vai vender bebidas?</dt><dd class="col-sm-6">{{ 'Sim' if licenca.vende_bebidas == 'sim' else 'Não' }}</dd>
                {% if licenca.vende_bebidas == 'sim' %}
                    <dt class="col-sm-6 text-muted ps-5">Tipo de casco:</dt><dd class="col-sm-6 text-muted">{{ licenca.tipo_casco|capitalize or 'Não informado' }}</dd>
                {% endif %}
                <dt class="col-sm-6">Utiliza estrutura montável?</dt><dd class="col-sm-6">{{ 'Sim' if licenca.usa_estrutura_montavel == 'sim' else 'Não' }}</dd>
                <dt class="col-sm-6">Utiliza churrasqueira?</dt><dd class="col-sm-6">{{ 'Sim' if licenca.usa_churrasqueira == 'sim' else 'Não' }}</dd>
                {% if licenca.usa_churrasqueira == 'sim' %}
                    <dt class="col-sm-6 text-muted ps-5">Tipo:</dt><dd class="col-sm-6 text-muted">{{ licenca.churrasqueira_tipo|capitalize or 'Não informado' }}</dd>
                    {% if licenca.churrasqueira_tipo == 'gas' %}
                        <dt class="col-sm-6 text-muted ps-5">Validade do gás:</dt><dd class="col-sm-6 text-muted">{{ 'Sim' if licenca.churrasqueira_gas_validade == 'sim' else 'Não' }}</dd>
                    {% endif %}
                {% endif %}
                <dt class="col-sm-6">Utiliza fritadeira a gás?</dt><dd class="col-sm-6">{{ 'Sim' if licenca.usa_fritadeira == 'sim' else 'Não' }}</dd>
                    {% if licenca.usa_fritadeira == 'sim' %}
                    <dt class="col-sm-6 text-muted ps-5">Validade do gás:</dt><dd class="col-sm-6 text-muted">{{ 'Sim' if licenca.fritadeira_gas_validade == 'sim' else 'Não' }}</dd>
                {% endif %}
                <dt class="col-sm-6">Manipula alimentos?</dt><dd class="col-sm-6">{{ 'Sim' if licenca.manipula_alimentos == 'sim' else 'Não' }}</dd>
                {% if licenca.manipula_alimentos == 'sim' %}
                    <dt class="col-sm-6 text-muted ps-5">Tem pia para lavagem?</dt><dd class="col-sm-6 text-muted">{{ 'Sim' if licenca.tem_pia == 'sim' else 'Não' }}</dd>
                {% endif %}
            </dl>
        </div>
    </div>

    <!-- 4. BOMBEIROS E DOCUMENTAÇÃO -->
    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">4. Liberação e Documentos</h6></div>
        <div class="card-body">
            <p><strong>Liberação do Corpo de Bombeiros:</strong> {{ 'Sim' if licenca.bombeiros_liberacao == 'sim' else 'Não' }}</p>
            {% if licenca.bombeiros_liberacao == 'sim' %}
                <p class="ms-4"><strong>Nº da Autorização:</strong> {{ licenca.bombeiros_numero or 'Não informado' }}</p>
                <p class="ms-4"><strong>Data de Emissão:</strong> {{ licenca.bombeiros_data.strftime('%d/%m/%Y') if licenca.bombeiros_data }}</p>
            {% endif %}
            <h6 class="mt-4">Documentos Anexados:</h6>
            <ul class="list-group">
                {% set doc_map = {
                    "Cópia do CPF/CNPJ e RG": licenca.doc_cpf_cnpj_path,
                    "Autorização dos Bombeiros": licenca.doc_bombeiros_path,
                    "Cópia do alvará de funcionamento do local": licenca.doc_alvara_local_path,
                    "Autorização da prefeitura para evento em via pública": licenca.doc_autorizacao_rua_path
                } %}
                
                {% set has_docs = false %}
                {% for label, path in doc_map.items() %}
                    {% if path %}
                        {% set has_docs = true %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ label }}
                            <a href="{{ url_for('static', filename='uploads/' + path.replace('\\', '/')) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="fas fa-eye me-1"></i> Visualizar
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
                {% if not has_docs %}
                    <li class="list-group-item">Nenhum documento foi anexado.</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- :: INÍCIO DA ALTERAÇÃO :: Script para campo obrigatório -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('novo_status');
    const observacoesTextarea = document.getElementById('observacoes');
    const observacoesLabel = document.getElementById('label_observacoes');
    const originalLabel = observacoesLabel.innerHTML;

    function toggleObservacoesRequired() {
        const selectedValue = statusSelect.value;
        if (selectedValue === 'Reprovado' || selectedValue === 'Pendente com Observação') {
            observacoesTextarea.required = true;
            observacoesLabel.innerHTML = originalLabel + ' <span class="text-danger">*</span>';
        } else {
            observacoesTextarea.required = false;
            observacoesLabel.innerHTML = originalLabel;
        }
    }
    statusSelect.addEventListener('change', toggleObservacoesRequired);
    toggleObservacoesRequired();
});
</script>
<!-- :: FIM DA ALTERAÇÃO :: -->

{% endblock %}
