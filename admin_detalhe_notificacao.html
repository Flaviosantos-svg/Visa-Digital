{% extends 'layout.html' %}
{% block title %}Detalhe da Notificação {{ notificacao.protocolo_notificacao }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Detalhes da Notificação</h2>
        <div>
            <a href="{{ url_for('admin_gerar_pdf_notificacao', notificacao_id=notificacao.id) }}" class="btn btn-primary" target="_blank">Gerar Notificação (PDF)</a>
            <a href="{{ url_for('admin_analisar_notificacoes') }}" class="btn btn-secondary">Voltar à Lista</a>
        </div>
    </div>

    <div class="card bg-light mb-4 shadow-sm">
        <div class="card-body">
            {% if not notificacao.parecer_final or notificacao.parecer_final == 'Pendente' %}
            <h5 class="card-title">Parecer Final do Administrador</h5>
            <form method="POST" action="{{ url_for('admin_salvar_parecer_notificacao', notificacao_id=notificacao.id) }}">
                <div class="mb-3">
                    <label class="form-label">Selecione o resultado final:</label>
                    <div class="form-check"><input type="radio" name="parecer_final" value="Cumprida" class="form-check-input" required> <label class="form-check-label">Cumprida</label></div>
                    <div class="form-check"><input type="radio" name="parecer_final" value="Não Cumprida" class="form-check-input"> <label class="form-check-label">Não Cumprida</label></div>
                    <div class="form-check"><input type="radio" name="parecer_final" value="Convertida em Auto de Infração" class="form-check-input"> <label class="form-check-label">Convertida em Auto de Infração</label></div>
                </div>
                <div class="mb-3">
                    <label for="justificativa_parecer" class="form-label">Justificativa / Observações Finais</label>
                    <textarea name="justificativa_parecer" class="form-control" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-success">Salvar Parecer</button>
            </form>
            {% else %}
            <h5 class="card-title">Parecer Final Registrado</h5>
            <dl class="row mb-0">
                <dt class="col-sm-3">Resultado:</dt>
                <dd class="col-sm-9">
                    {% if notificacao.parecer_final == 'Cumprida' %}<span class="badge bg-success fs-6">{{ notificacao.parecer_final }}</span>
                    {% else %}<span class="badge bg-danger fs-6">{{ notificacao.parecer_final }}</span>
                    {% endif %}
                </dd>
                <dt class="col-sm-3 mt-2">Observações:</dt>
                <dd class="col-sm-9 mt-2">{{ notificacao.justificativa_parecer or 'Nenhuma.' }}</dd>
            </dl>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <strong>Protocolo: {{ notificacao.protocolo_notificacao }}</strong>
        </div>
        <div class="card-body">
            <h5 class="card-title mb-3">1. Identificação do Notificado</h5>
            <dl class="row">
                {% if notificacao.empresa %}
                    <dt class="col-sm-3">Tipo:</dt>
                    <dd class="col-sm-9">Empresa Cadastrada</dd>
                    <dt class="col-sm-3">Razão Social:</dt>
                    <dd class="col-sm-9">{{ notificacao.empresa.razao_social }}</dd>
                    <dt class="col-sm-3">CNPJ:</dt>
                    <dd class="col-sm-9">{{ notificacao.empresa.cnpj }}</dd>
                {% elif notificacao.autonomo %}
                    <dt class="col-sm-3">Tipo:</dt>
                    <dd class="col-sm-9">Autônomo Cadastrado</dd>
                    <dt class="col-sm-3">Nome:</dt>
                    <dd class="col-sm-9">{{ notificacao.autonomo.nome }}</dd>
                    <dt class="col-sm-3">CPF:</dt>
                    <dd class="col-sm-9">{{ notificacao.autonomo.cpf }}</dd>
                {% else %}
                    <dt class="col-sm-3">Tipo:</dt>
                    <dd class="col-sm-9">Notificação Avulsa</dd>
                    <dt class="col-sm-3">Nome:</dt>
                    <dd class="col-sm-9">{{ notificacao.notificado_avulso_nome or 'Não informado' }}</dd>
                    <dt class="col-sm-3">Documento:</dt>
                    <dd class="col-sm-9">{{ notificacao.notificado_avulso_documento or 'Não informado' }}</dd>
                    <dt class="col-sm-3">Telefone:</dt>
                    <dd class="col-sm-9">{{ notificacao.notificado_avulso_telefone or 'Não informado' }}</dd>
                    <dt class="col-sm-3">Endereço:</dt>
                    <dd class="col-sm-9">{{ notificacao.notificado_avulso_endereco or 'Não informado' }}</dd>
                {% endif %}
            </dl>
            <hr>

            <h5 class="card-title my-3">2. Detalhes da Notificação</h5>
            <dl class="row">
                <dt class="col-sm-3">Data da Vistoria:</dt>
                <dd class="col-sm-9">{{ notificacao.data_notificacao.strftime('%d/%m/%Y') if notificacao.data_notificacao else '' }}</dd>
                <dt class="col-sm-3">Irregularidades:</dt>
                <dd class="col-sm-9"><pre class="mb-0 bg-light p-2 rounded">{{ notificacao.descricao_irregularidade or 'Nenhuma irregularidade descrita.' }}</pre></dd>
            </dl>
            <hr>

            <h5 class="card-title my-3">3. Observações e Fotos</h5>
            <dl class="row">
                <dt class="col-sm-3">Observações:</dt>
                <dd class="col-sm-9">{{ notificacao.motivo_notificacao or 'Nenhuma observação adicional.' }}</dd>
            </dl>
            <div class="row mt-3">
                {% if notificacao.anexos %}
                    {% for foto in notificacao.anexos.split(',') %}
                    <div class="col-md-4 col-lg-3 mb-3">
                        <a href="{{ url_for('static', filename='uploads/' + foto) }}" target="_blank">
                            <img src="{{ url_for('static', filename='uploads/' + foto) }}" class="img-fluid rounded" alt="Foto anexa">
                        </a>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Nenhuma foto foi anexada.</p>
                {% endif %}
            </div>
            <hr>

            <h5 class="card-title my-3">4. Fiscais Responsáveis</h5>
            <dl class="row">
                <dt class="col-sm-3">Equipe:</dt>
                <dd class="col-sm-9">{{ notificacao.fiscal_nome or 'Não informado' }}</dd>
            </dl>
            <hr>
            
            <h5 class="card-title my-3">5. Responsável pelas Informações</h5>
            <dl class="row">
                <dt class="col-sm-3">Nome:</dt>
                <dd class="col-sm-9">{{ notificacao.ciencia_nome or 'Não informado' }}</dd>
                <dt class="col-sm-3">CPF:</dt>
                <dd class="col-sm-9">{{ notificacao.ciencia_documento or 'Não informado' }}</dd>
            </dl>
        </div>
    </div>
</div>
{% endblock %}