{% extends 'admin_base.html' %}

{% block title %}Analisar Solicitação de Teste de Calazar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Análise de Solicitação - Protocolo {{ solicitacao.protocolo }}</h1>
        <a href="{{ url_for('admin_listar_solicitacao_calazar') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para a Lista
        </a>
    </div>

    <div class="row">
        <!-- Coluna da Esquerda: Dados da Solicitação -->
        <div class="col-lg-7">
            <!-- 1. Dados do Proprietário -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">1. Dados do Proprietário</h6>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Nome:</dt><dd class="col-sm-8">{{ solicitacao.proprietario_nome }}</dd>
                        <dt class="col-sm-4">CPF:</dt><dd class="col-sm-8">{{ solicitacao.proprietario_cpf }}</dd>
                        <dt class="col-sm-4">Endereço:</dt><dd class="col-sm-8">{{ solicitacao.proprietario_endereco }}</dd>
                        <dt class="col-sm-4">Telefone:</dt><dd class="col-sm-8">{{ solicitacao.proprietario_telefone }}</dd>
                    </dl>
                </div>
            </div>

            <!-- 2. Dados do Animal -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">2. Dados do Animal</h6>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Nome:</dt><dd class="col-sm-8">{{ solicitacao.animal_nome }}</dd>
                        <dt class="col-sm-4">Espécie:</dt><dd class="col-sm-8">{{ solicitacao.animal_especie }}</dd>
                        <dt class="col-sm-4">Raça:</dt><dd class="col-sm-8">{{ solicitacao.animal_raca }}</dd>
                        <dt class="col-sm-4">Sexo:</dt><dd class="col-sm-8">{{ solicitacao.animal_sexo }}</dd>
                        <dt class="col-sm-4">Idade:</dt><dd class="col-sm-8">{{ solicitacao.animal_idade }}</dd>
                        <dt class="col-sm-4">Cor:</dt><dd class="col-sm-8">{{ solicitacao.animal_cor }}</dd>
                    </dl>
                </div>
            </div>

            <!-- 3. Informações Clínicas -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">3. Informações Clínicas e Coleta Sugerida</h6>
                </div>
                <div class="card-body">
                    <h6>Sinais Clínicos Apresentados:</h6>
                    <p class="text-muted">{{ solicitacao.sinais_clinicos or 'Nenhum sinal clínico informado.' }}</p>
                    <hr>
                    <p><strong>Data Sugerida para Coleta:</strong> {{ solicitacao.data_coleta_sugerida.strftime('%d/%m/%Y') if solicitacao.data_coleta_sugerida else 'N/A' }}</p>
                    <p><strong>Horário Sugerido:</strong> {{ solicitacao.horario_coleta_sugerido or 'N/A' }}</p>
                </div>
            </div>

            <!-- 4. Fotos do Animal -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">4. Fotos do Animal</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h6>Focinho</h6>
                            {% if solicitacao.foto_focinho_path %}
                                <a href="{{ url_for('static', filename='uploads/' + solicitacao.foto_focinho_path) }}" target="_blank">
                                    <img src="{{ url_for('static', filename='uploads/' + solicitacao.foto_focinho_path) }}" class="img-fluid rounded" alt="Foto do Focinho">
                                </a>
                            {% else %}
                                <p class="text-muted">Não enviada</p>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h6>Patas</h6>
                            {% if solicitacao.foto_patas_path %}
                                <a href="{{ url_for('static', filename='uploads/' + solicitacao.foto_patas_path) }}" target="_blank">
                                    <img src="{{ url_for('static', filename='uploads/' + solicitacao.foto_patas_path) }}" class="img-fluid rounded" alt="Foto das Patas">
                                </a>
                            {% else %}
                                <p class="text-muted">Não enviada</p>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h6>Corpo Inteiro</h6>
                            {% if solicitacao.foto_corpo_inteiro_path %}
                                <a href="{{ url_for('static', filename='uploads/' + solicitacao.foto_corpo_inteiro_path) }}" target="_blank">
                                    <img src="{{ url_for('static', filename='uploads/' + solicitacao.foto_corpo_inteiro_path) }}" class="img-fluid rounded" alt="Foto do Corpo Inteiro">
                                </a>
                            {% else %}
                                <p class="text-muted">Não enviada</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna da Direita: Ações do Administrador -->
        <div class="col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">5. Análise e Ações</h6>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('admin_atualizar_status_calazar', solicitacao_id=solicitacao.id) }}" method="POST" enctype="multipart/form-data">
                        <!-- :: INÍCIO DA ALTERAÇÃO :: -->
                        <div class="mb-3">
                            <label for="status" class="form-label fw-bold">Alterar Status:</label>
                            <select name="status" id="status" class="form-select">
                                <option value="Solicitado" {% if solicitacao.status == 'Solicitado' %}selected{% endif %}>Solicitado</option>
                                <option value="Material Coletado" {% if solicitacao.status == 'Material Coletado' %}selected{% endif %}>Material Coletado</option>
                                <option value="Teste Realizado" {% if solicitacao.status == 'Teste Realizado' %}selected{% endif %}>Teste Realizado</option>
                                <option value="Concluído" {% if solicitacao.status == 'Concluído' %}selected{% endif %}>Concluído</option>
                                <option value="Cancelado" {% if solicitacao.status == 'Cancelado' %}selected{% endif %}>Cancelado</option>
                            </select>
                        </div>
                        <hr>
                        
                        <!-- Agendamento e Realização do Teste -->
                        <h6 class="text-info">Agendamento e Coleta</h6>
                        <div class="mb-3">
                            <label for="data_atendimento" class="form-label">Data do Atendimento/Coleta:</label>
                            <input type="date" class="form-control" id="data_atendimento" name="data_atendimento" value="{{ solicitacao.data_atendimento.strftime('%Y-%m-%d') if solicitacao.data_atendimento }}">
                        </div>
                        <div class="mb-3">
                            <label for="data_realizacao_teste" class="form-label">Data de Realização do Teste:</label>
                            <input type="date" class="form-control" id="data_realizacao_teste" name="data_realizacao_teste" value="{{ solicitacao.data_realizacao_teste.strftime('%Y-%m-%d') if solicitacao.data_realizacao_teste }}">
                        </div>
                        <hr>

                        <!-- Resultado do Teste -->
                        <h6 class="text-success">Resultado do Teste</h6>
                        <div class="mb-3">
                            <label for="resultado_teste_rapido" class="form-label">Resultado do Teste Rápido:</label>
                            <select name="resultado_teste_rapido" id="resultado_teste_rapido" class="form-select">
                                <option value="" {% if not solicitacao.resultado_teste_rapido %}selected{% endif %}>Não realizado</option>
                                <option value="Positivo" {% if solicitacao.resultado_teste_rapido == 'Positivo' %}selected{% endif %}>Positivo</option>
                                <option value="Negativo" {% if solicitacao.resultado_teste_rapido == 'Negativo' %}selected{% endif %}>Negativo</option>
                                <option value="Inconclusivo" {% if solicitacao.resultado_teste_rapido == 'Inconclusivo' %}selected{% endif %}>Inconclusivo</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="foto_teste_rapido" class="form-label">Anexar Foto do Teste:</label>
                            {% if solicitacao.foto_teste_rapido_path %}
                                <div class="mb-2">
                                    <a href="{{ url_for('static', filename='uploads/' + solicitacao.foto_teste_rapido_path) }}" target="_blank">
                                        <i class="fas fa-camera"></i> Ver foto atual
                                    </a>
                                </div>
                            {% endif %}
                            <input type="file" class="form-control" id="foto_teste_rapido" name="foto_teste_rapido" accept="image/*">
                        </div>
                        
                        <div class="mb-3">
                            <label for="kit_utilizado" class="form-label">Kit Utilizado:</label>
                            <input type="text" class="form-control" id="kit_utilizado" name="kit_utilizado" value="{{ solicitacao.kit_utilizado or '' }}">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lote_kit" class="form-label">Lote:</label>
                                <input type="text" class="form-control" id="lote_kit" name="lote_kit" value="{{ solicitacao.lote_kit or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="validade_kit" class="form-label">Validade:</label>
                                <input type="text" class="form-control" id="validade_kit" name="validade_kit" value="{{ solicitacao.validade_kit or '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="veterinario_responsavel_nome" class="form-label">Veterinário Responsável:</label>
                            <input type="text" class="form-control" id="veterinario_responsavel_nome" name="veterinario_responsavel_nome" value="{{ solicitacao.veterinario_responsavel_nome or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="veterinario_crmv" class="form-label">CRMV:</label>
                            <input type="text" class="form-control" id="veterinario_crmv" name="veterinario_crmv" value="{{ solicitacao.veterinario_crmv or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="observacoes_resultado" class="form-label">Observações:</label>
                            <textarea class="form-control" name="observacoes_resultado" id="observacoes_resultado" rows="3">{{ solicitacao.observacoes_resultado or '' }}</textarea>
                        </div>
                        <!-- :: FIM DA ALTERAÇÃO :: -->

                        <div class="form-check form-switch mb-3 p-3 border rounded">
                            <input class="form-check-input" type="checkbox" role="switch" id="resultado_liberado" name="resultado_liberado" value="true" {% if solicitacao.resultado_liberado %}checked{% endif %}>
                            <label class="form-check-label" for="resultado_liberado">Disponibilizar laudo para impressão pelo cidadão?</label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                    </form>

                    {% if solicitacao.status in ['Teste Realizado', 'Concluído'] %}
                    <hr>
                    <div class="mt-3 text-center">
                        <a href="{{ url_for('admin_imprimir_resultado_calazar', solicitacao_id=solicitacao.id) }}" target="_blank" class="btn btn-success">
                            <i class="fas fa-print me-2"></i>Imprimir Laudo
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('status');
    const observacoesTextarea = document.getElementById('observacoes_resultado');
    const observacoesLabel = document.querySelector('label[for="observacoes_resultado"]');
    const originalLabelText = observacoesLabel.textContent;

    function toggleObservationRequirement() {
        if (statusSelect.value === 'Cancelado') {
            observacoesTextarea.required = true;
            observacoesLabel.innerHTML = originalLabelText + ' <span class="text-danger">*</span>';
            observacoesTextarea.placeholder = 'Motivo do cancelamento (obrigatório)';
        } else {
            observacoesTextarea.required = false;
            observacoesLabel.innerHTML = originalLabelText;
            observacoesTextarea.placeholder = '';
        }
    }

    // Verifica o estado inicial quando a página carrega
    toggleObservationRequirement();

    // Adiciona o listener para mudanças no select
    statusSelect.addEventListener('change', toggleObservationRequirement);
});
</script>
{% endblock %}
