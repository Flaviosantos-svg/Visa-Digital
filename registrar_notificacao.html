{% extends 'admin_base.html' %}
{% block title %}Emitir Notificação{% endblock %}

{% block styles %}
<!-- Adiciona o CDN do Bootstrap Icons para os ícones de câmera -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    /* Estilo para os ícones de upload de foto */
    .photo-upload-label {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 2rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .photo-upload-label:hover {
        background-color: #f8f9fa;
        border-color: #0d6efd;
    }
    .photo-upload-label .bi {
        font-size: 2rem;
        color: #6c757d;
    }
    .photo-upload-label span {
        display: block;
        margin-top: 0.5rem;
        color: #6c757d;
    }
    .photo-upload-input {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <h2 class="mb-4">Notificação da Vigilância Sanitária</h2>

    <!-- Formulário Único -->
    <form method="POST" enctype="multipart/form-data">
        
        <!-- 1. IDENTIFICAÇÃO -->
        <fieldset class="border p-3 mb-4 rounded">
            <legend class="w-auto px-2 h6">1. Identificação</legend>
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label for="cnpj_cpf" class="form-label">CNPJ ou CPF</label>
                    <input type="text" class="form-control" id="cnpj_cpf" name="cnpj_cpf" value="{{ cnpj_pesquisado }}" required>
                </div>
                <div class="col-md-3">
                    <button type="submit" name="action" value="buscar_empresa" class="btn btn-secondary w-100">Buscar Dados</button>
                </div>
            </div>
        </fieldset>

        <!-- Esta seção só aparece DEPOIS que uma busca for realizada -->
        {% if search_performed %}

            <!-- Bloco A: Se um cadastro FOI ENCONTRADO -->
            {% if entidade %}
            <div id="entidade-encontrada-bloco" class="alert alert-success">
                <p class="mb-1"><strong>Cadastro Encontrado:</strong></p>
                <p class="mb-0">{{ entidade.nome_principal }}</p>
                <input type="hidden" name="entidade_id" value="{{ entidade.id }}">
                <input type="hidden" name="entidade_tipo" value="{{ entidade.tipo }}">
            </div>
            {% endif %}

            <!-- Bloco B: Se um cadastro NÃO FOI ENCONTRADO (Opção Avulsa) -->
            {% if show_unidentified_option %}
            <div id="opcao-avulsa-bloco" class="card shadow-sm mb-4">
                <div class="card-body bg-light">
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" role="switch" id="unidentifiedSwitch" name="unidentified_notification_choice">
                        <label class="form-check-label fw-bold" for="unidentifiedSwitch">Deseja registrar uma Notificação Avulsa?</label>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Container para os campos da Notificação Avulsa (controlado por JS) -->
            <div id="campos-avulsos-container" style="display: none;">
                <fieldset class="border p-3 rounded mb-4">
                    <legend class="w-auto px-2 h6">Dados da Notificação Avulsa</legend>
                    <div class="row g-3">
                        <div class="col-md-12"><label class="form-label">Nome Completo</label><input type="text" class="form-control" name="unidentified_nome"></div>
                        <div class="col-md-6"><label class="form-label">CPF ou CNPJ</label><input type="text" class="form-control" name="unidentified_cpf_cnpj"></div>
                        <div class="col-md-6"><label class="form-label">Telefone</label><input type="text" class="form-control" name="unidentified_telefone"></div>
                        <div class="col-md-12"><label class="form-label">Endereço</label><input type="text" class="form-control" name="unidentified_endereco"></div>
                    </div>
                </fieldset>
            </div>

            <!-- Corpo principal do formulário (comum a todos) -->
            <div id="corpo-principal-formulario" style="display: none;">
                <!-- 2. DETALHES DA NOTIFICAÇÃO -->
                <fieldset class="border p-3 mb-4 rounded">
                    <legend class="w-auto px-2 h6">2. Detalhes da Notificação</legend>
                    <div class="mb-3"><label class="form-label">Data da Vistoria</label><input type="date" class="form-control" name="data_vistoria_origem" required></div>
                    <div>
                        <label class="form-label">Irregularidades Constatadas e Prazos</label>
                        <div id="irregularidades-container">
                            <div class="row g-2 mb-2 irregularidade-row">
                                <div class="col-md-7"><select name="irregularidade_id" class="form-select" required><option value="" disabled selected>Selecione...</option>{% for irreg in irregularidades_lista %}<option value="{{ irreg.id }}">{{ irreg.nome }}</option>{% endfor %}</select></div>
                                <div class="col-md-4"><input type="text" name="prazo_irregularidade" class="form-control" placeholder="Prazo" required></div>
                                <div class="col-md-1"></div>
                            </div>
                        </div>
                        <button type="button" id="add-irregularidade-btn" class="btn btn-success btn-sm mt-2">+ Acrescentar</button>
                    </div>
                </fieldset>

                <!-- 3. OBSERVAÇÕES E FOTOS -->
                <fieldset class="border p-3 mb-4 rounded">
                    <legend class="w-auto px-2 h6">3. Observações e Fotos</legend>
                    <div class="mb-4"><label class="form-label">Observações</label><textarea name="observacoes_adicionais" class="form-control" rows="3"></textarea></div>
                    <label class="form-label">Anexos Fotográficos</label>
                    <div class="row">
                        {% for i in range(1, 11) %}
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <label for="foto_{{ i }}" class="photo-upload-label">
                                <i class="bi bi-camera-fill"></i>
                                <span>Foto {{ i }}</span>
                            </label>
                            <input type="file" name="foto_{{ i }}" id="foto_{{ i }}" class="photo-upload-input" accept="image/*" capture="environment">
                        </div>
                        {% endfor %}
                    </div>
                </fieldset>

                <!-- 4. FISCAIS RESPONSÁVEIS -->
                <fieldset class="border p-3 mb-4 rounded">
                    <legend class="w-auto px-2 h6">4. Fiscais Responsáveis</legend>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fiscal 1</label>
                            <select name="fiscal_id_1" class="form-select" required>
                                <option value="" disabled selected>Selecione...</option>
                                {% for fiscal in fiscais_lista %}<option value="{{ fiscal.id }}">{{ fiscal.nome }} (Mat: {{ fiscal.matricula }})</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fiscal 2 (Opcional)</label>
                            <select name="fiscal_id_2" class="form-select">
                                <option value="">Nenhum</option>
                                {% for fiscal in fiscais_lista %}<option value="{{ fiscal.id }}">{{ fiscal.nome }} (Mat: {{ fiscal.matricula }})</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                </fieldset>

                <!-- 5. RESPONSÁVEL PELAS INFORMAÇÕES -->
                <fieldset class="border p-3 mb-4 rounded">
                    <legend class="w-auto px-2 h6">5. Responsável pelas Informações</legend>
                    <div class="row">
                        <div class="col-md-8 mb-3"><label class="form-label">Nome do Responsável</label><input type="text" name="responsavel_info_nome" class="form-control" required></div>
                        <div class="col-md-4 mb-3"><label class="form-label">CPF do Responsável</label><input type="text" name="responsavel_info_cpf" class="form-control" required></div>
                    </div>
                </fieldset>

                <button type="submit" name="action" value="salvar_notificacao" class="btn btn-danger btn-lg w-100">Emitir e Salvar Notificação</button>
            </div>
        {% endif %} <!-- Fim do bloco que só aparece após a busca -->
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const unidentifiedSwitch = document.getElementById('unidentifiedSwitch');
    const avulsaFields = document.getElementById('campos-avulsos-container');
    const corpoPrincipal = document.getElementById('corpo-principal-formulario');
    const entidadeEncontrada = document.getElementById('entidade-encontrada-bloco');

    // --- LÓGICA DE VISIBILIDADE SIMPLIFICADA E CORRIGIDA ---
    function updateFormVisibility() {
        const isAvulsaChecked = unidentifiedSwitch ? unidentifiedSwitch.checked : false;

        // Mostra o formulário principal se uma entidade foi encontrada OU se a opção avulsa está marcada
        if (entidadeEncontrada || isAvulsaChecked) {
            corpoPrincipal.style.display = 'block';
        } else {
            corpoPrincipal.style.display = 'none';
        }

        // Mostra os campos avulsos apenas se a opção avulsa está marcada
        if (isAvulsaChecked) {
            avulsaFields.style.display = 'block';
        } else {
            avulsaFields.style.display = 'none';
        }
    }

    if (unidentifiedSwitch) {
        unidentifiedSwitch.addEventListener('change', updateFormVisibility);
    }
    
    // Define o estado inicial da página ao carregar
    updateFormVisibility();

    // Lógica para adicionar irregularidades
    const irregularidadesContainer = document.getElementById('irregularidades-container');
    const addButton = document.getElementById('add-irregularidade-btn');

    if (addButton) {
        addButton.addEventListener('click', function() {
            const newRow = document.createElement('div');
            newRow.classList.add('row', 'g-2', 'mb-2', 'irregularidade-row');
            
            let selectHTML = '<select name="irregularidade_id" class="form-select" required>';
            selectHTML += '<option value="" disabled selected>Selecione...</option>';
            {% for irreg in irregularidades_lista %}
                selectHTML += `<option value="{{ irreg.id }}">{{ irreg.nome }}</option>`;
            {% endfor %}
            selectHTML += '</select>';

            newRow.innerHTML = `
                <div class="col-md-7">${selectHTML}</div>
                <div class="col-md-4"><input type="text" name="prazo_irregularidade" class="form-control" placeholder="Prazo" required></div>
                <div class="col-md-1 d-flex align-items-center"><button type="button" class="btn btn-danger btn-sm remove-irregularidade-btn">X</button></div>
            `;
            irregularidadesContainer.appendChild(newRow);
        });
    }

    // Lógica para remover a linha de irregularidade
    if (irregularidadesContainer) {
        irregularidadesContainer.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('remove-irregularidade-btn')) {
                event.target.closest('.irregularidade-row').remove();
            }
        });
    }
});
</script>
{% endblock %}
