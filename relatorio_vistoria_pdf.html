<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Inspeção Sanitária - {{ vistoria.protocolo_vistoria }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            font-size: 11pt;
            background-color: #fff;
        }
        .report-container {
            max-width: 800px;
            margin: auto;
            padding: 2rem;
        }
        .report-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .section-title {
            font-weight: bold;
            background-color: #e9ecef;
            padding: 0.3rem;
            margin-top: 1.5rem;
            border: 1px solid #dee2e6;
            font-size: 12pt;
        }
        .signature-line {
            border-top: 1px solid #000;
            margin-top: 3rem;
            padding-top: 0.5rem;
            text-align: center;
        }
        .signature-block {
            margin-top: 4rem;
        }
        dl.row dt {
            font-weight: bold;
        }
        .checklist-table td {
            vertical-align: middle;
        }
        .page-break {
            page-break-before: always;
        }
        @media print {
            .no-print {
                display: none;
            }
            body {
                font-size: 10pt;
            }
            .report-container {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="no-print mb-4 text-center">
            <button onclick="window.print()" class="btn btn-primary">Imprimir / Salvar como PDF</button>
            <a href="{{ url_for('admin_detalhe_vistoria', vistoria_id=vistoria.id) }}" class="btn btn-secondary">Voltar</a>
        </div>

        <div class="report-header">
            <!-- Você pode adicionar o logo da sua prefeitura aqui -->
            
            
            
            
            <h4>RELATÓRIO DE INSPEÇÃO SANITÁRIA Nº {{ vistoria.protocolo_vistoria }}</h4>
        </div>

        <p class="section-title">1. IDENTIFICAÇÃO DO ESTABELECIMENTO INSPECIONADO</p>
        <dl class="row g-2">
            <dt class="col-4">Razão Social:</dt>
            <dd class="col-8">{{ vistoria.empresa.razao_social if vistoria.empresa else 'Não informado' }}</dd>
            <dt class="col-4">Nome Fantasia:</dt>
            <dd class="col-8">{{ vistoria.empresa.nome_fantasia if vistoria.empresa else 'Não informado' }}</dd>
            <dt class="col-4">CNPJ/CPF:</dt>
            <dd class="col-8">{{ vistoria.empresa.cnpj if vistoria.empresa else 'N/A' }}</dd>
            <dt class="col-4">Endereço Completo:</dt>
            <dd class="col-8">{{ vistoria.empresa.endereco if vistoria.empresa else 'Não informado' }}</dd>
            <dt class="col-4">Telefone de Contato:</dt>
            <dd class="col-8">{{ vistoria.empresa.telefone_empresa if vistoria.empresa else 'Não informado' }}</dd>
            <dt class="col-4">E-mail:</dt>
            <dd class="col-8">{{ vistoria.empresa.email if vistoria.empresa else 'Não informado' }}</dd>
            <dt class="col-4">Atividade Principal (CNAE):</dt>
            <dd class="col-8">{{ vistoria.empresa.cnae_principal if vistoria.empresa else 'Não informado' }}</dd>
            <dt class="col-4">Responsável Legal:</dt>
            <dd class="col-8">{{ vistoria.empresa.responsavel_juridico_nome if vistoria.empresa else 'Não informado' }}</dd>
        </dl>

        <p class="section-title">2. DADOS DA INSPEÇÃO</p>
        <dl class="row g-2">
            <dt class="col-4">Data da Inspeção:</dt>
            <dd class="col-8">{{ vistoria.data_vistoria.strftime('%d/%m/%Y') if vistoria.data_vistoria else 'Não informada' }}</dd>
            <dt class="col-4">Objetivo da Inspeção:</dt>
            <dd class="col-8">{{ vistoria.motivo or 'Não informado' }}</dd>
            <dt class="col-4">Equipe Inspetora:</dt>
            <dd class="col-8">
                {% for fiscal in fiscais %}
                    {{ fiscal.nome }} (Matrícula: {{ fiscal.matricula }}){% if not loop.last %}<br>{% endif %}
                {% else %}
                    Não informado.
                {% endfor %}
            </dd>
        </dl>

        <p class="section-title">3. BASE LEGAL E DOCUMENTAL</p>
        <p>Documentos Apresentados:</p>
        <ul>
            {% for doc, status in documentacao_verificada.items() %}
                <li>{{ doc }}: <strong>{{ status }}</strong></li>
            {% else %}
                <li>Nenhuma verificação de documento registrada.</li>
            {% endfor %}
        </ul>

        <p class="section-title">4. PERGUNTAS E RESPOSTAS DO CHECKLIST</p>
        <table class="table table-sm table-bordered checklist-table">
            <tbody>
                {% for item in perguntas_com_respostas %}
                    <tr>
                        <td>{{ item.texto }}</td>
                        <td style="width: 20%; text-align: center;">{{ item.resposta }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="2">Nenhum item do checklist preenchido.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <p class="section-title">5. CONCLUSÃO</p>
        <p>Diante do exposto e com base nas observações realizadas durante a vistoria, o estabelecimento foi classificado como: <strong>{{ vistoria.status_analise|upper or 'PENDENTE' }}</strong>.</p>

        <p class="section-title">6. RECOMENDAÇÕES E/OU EXIGÊNCIAS</p>
        <p>Com base nas não conformidades identificadas, o estabelecimento deverá tomar as seguintes providências:</p>
        <ul>
            {% if observacoes_data.recomendacoes %}
                {% for item in observacoes_data.recomendacoes %}
                    <li>{{ item.recomendacao }} - <strong>Prazo: {{ item.prazo }} dias.</strong></li>
                {% endfor %}
            {% else %}
                <li>Nenhuma recomendação específica.</li>
            {% endif %}
        </ul>

        <p class="section-title">7. ENCERRAMENTO</p>
        <p class="text-center mt-4">Nada mais havendo a constar, lavra-se o presente relatório em 2 (duas) vias de igual teor e forma, que após lido e achado conforme, vai assinado pela equipe inspetora e pelo representante do estabelecimento.</p>
        <p class="text-center">Esperantina, {{ vistoria.data_vistoria.strftime('%d de %B de %Y') if vistoria.data_vistoria else '[Data]' }}.</p>

        <div class="signature-block">
            {% for fiscal in fiscais %}
            <div class="signature-line">
                {{ fiscal.nome }}<br>
                Inspetor(a) Sanitário(a)<br>
                Matrícula: {{ fiscal.matricula }}
            </div>
            {% endfor %}
            
            <div class="signature-line">
                Ciente e de acordo:<br>
                (Representante do Estabelecimento)
            </div>
        </div>

        <!-- Seção de fotos com layout 2x2 e quebra de página -->
        {% if fotos %}
        <div class="page-break"></div>
        <div class="report-header">
            <h4>Anexos Fotográficos</h4>
        </div>
        <div class="container-fluid">
            <div class="row">
                {% for foto_filename in fotos %}
                <div class="col-6 mb-3 d-flex justify-content-center align-items-center" style="height: 13cm;">
                    <!-- CORREÇÃO APLICADA: Removido o parâmetro _external=True -->
                    <img src="{{ url_for('static', filename='uploads/fotos_vistorias/' + foto_filename) }}" style="max-width: 100%; max-height: 100%; border: 1px solid #ccc; padding: 5px; object-fit: contain;">
                </div>
                
                {# Adiciona uma quebra de página a cada 4 fotos para manter o layout 2x2 #}
                {% if loop.index % 4 == 0 and not loop.last %}
                    </div> <!-- fecha a row atual -->
                    </div> <!-- fecha o container-fluid -->
                    <div class="page-break"></div>
                    <div class="report-header">
                        <h4>Anexos Fotográficos (continuação)</h4>
                    </div>
                    <div class="container-fluid">
                    <div class="row"> <!-- abre uma nova row -->
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</body>
</html>
