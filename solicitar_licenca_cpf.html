{% extends 'admin_base.html' %}
{% block title %}Licença para Autônomo{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <h1 class="h3 mb-4 text-gray-800">Solicitar Licença Autônomo</h1>
    
    <!-- Formulário de Busca por CPF -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Buscar Autônomo por CPF</h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('solicitar_licenca_cpf') }}">
                <div class="input-group">
                    <input type="text" name="cpf_busca" class="form-control" placeholder="Digite o CPF do autônomo para buscar..." value="{{ query_cpf or '' }}" required>
                    <button class="btn btn-primary" type="submit"><i class="fas fa-search me-2"></i>Buscar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulário de Licença (só aparece se o autônomo for encontrado) -->
    {% if autonomo %}
    <form action="{{ url_for('salvar_licenca_autonomo') }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="autonomo_id" value="{{ autonomo.id }}">

        <!-- Dados Pessoais -->
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">1. Dados Pessoais do Autônomo</h6></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-12"><label class="form-label">Nome Completo</label><input type="text" class="form-control" value="{{ autonomo.nome_completo or '' }}" readonly></div>
                    <div class="col-md-6"><label class="form-label">CPF</label><input type="text" class="form-control" value="{{ autonomo.cpf or '' }}" readonly></div>
                    <div class="col-md-6"><label class="form-label">RG</label><input type="text" class="form-control" value="{{ autonomo.rg or '' }}" readonly></div>
                    <div class="col-md-4"><label class="form-label">Data de Nascimento</label><input type="text" class="form-control" value="{{ autonomo.data_nascimento.strftime('%d/%m/%Y') if autonomo.data_nascimento else '' }}" readonly></div>
                    <div class="col-md-4"><label class="form-label">Nacionalidade</label><input type="text" name="nacionalidade" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label">Estado Civil</label><input type="text" name="estado_civil" class="form-control"></div>
                    <div class="col-md-12"><label class="form-label">Profissão</label><input type="text" class="form-control" value="{{ autonomo.profissao or '' }}" readonly></div>
                    <div class="col-md-6"><label class="form-label">Telefone</label><input type="text" class="form-control" value="{{ autonomo.telefone_celular or '' }}" readonly></div>
                    <div class="col-md-6"><label class="form-label">E-mail</label><input type="email" class="form-control" value="{{ autonomo.email or '' }}" readonly></div>
                </div>
            </div>
        </div>
        
        <!-- Endereço Residencial -->
        <div class="card shadow mb-4">
             <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">2. Endereço Residencial</h6></div>
             <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-12"><label class="form-label">Endereço</label><input type="text" class="form-control" value="{{ autonomo.endereco_atendimento }}" readonly></div>
                </div>
             </div>
        </div>

        <!-- Local de Atuação -->
        <div class="card shadow mb-4">
             <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">3. Local de Atuação</h6></div>
             <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-12"><label class="form-label">Endereço Completo</label><input type="text" name="local_atuacao_endereco" class="form-control" placeholder="Pode ser o mesmo da residência ou outro local"></div>
                    <div class="col-md-12"><label class="form-label">Tipo de Local</label><input type="text" name="local_atuacao_tipo" class="form-control" placeholder="Residencial, comercial, atendimento externo/domiciliar"></div>
                    <div class="col-md-12"><label class="form-label">Ponto de Referência</label><input type="text" name="local_atuacao_referencia" class="form-control"></div>
                </div>
             </div>
        </div>

        <!-- Dados da Atividade -->
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">4. Dados da Atividade Exercida</h6></div>
            <div class="card-body">
                <!-- :: INÍCIO DA ALTERAÇÃO :: -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Ano de Exercício</label>
                        <input type="number" name="ano_exercicio" class="form-control" value="{{ ano_atual }}" required>
                    </div>
                </div>
                <!-- :: FIM DA ALTERAÇÃO :: -->
                <div class="mb-3"><label class="form-label">Descrição da Atividade</label><textarea name="descricao_atividade" class="form-control" rows="3"></textarea></div>
                <div class="mb-3"><label class="form-label d-block">Possui RT?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="possui_rt" id="rt_sim" value="sim"><label class="form-check-label" for="rt_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="possui_rt" id="rt_nao" value="nao" checked><label class="form-check-label" for="rt_nao">Não</label></div></div>
                <div id="rt-div" class="p-3 mb-3 border rounded bg-light" style="display: none;"><h6>Dados do RT</h6><div class="row"><div class="col-md-6"><input type="text" name="rt_nome" class="form-control mb-2" placeholder="Nome"></div><div class="col-md-6"><input type="text" name="rt_cpf" class="form-control mb-2" placeholder="CPF"></div><div class="col-md-6"><input type="text" name="rt_conselho" class="form-control mb-2" placeholder="Nº do Conselho"></div><div class="col-md-6"><label class="form-label small">Anexar Declaração de RT</label><input type="file" name="rt_declaracao" class="form-control"></div></div></div>
                <div class="mb-3"><label class="form-label d-block">Utiliza perfuro cortantes?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="usa_perfuro" value="sim"><label class="form-check-label">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="usa_perfuro" value="nao" checked><label class="form-check-label">Não</label></div></div>
                <div class="mb-3"><label class="form-label d-block">Faz algum procedimento invasivo?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="faz_invasivo" id="invasivo_sim" value="sim"><label class="form-check-label" for="invasivo_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="faz_invasivo" id="invasivo_nao" value="nao" checked><label class="form-check-label" for="invasivo_nao">Não</label></div></div>
                <div id="invasivo-div" class="p-3 mb-3 border rounded bg-light" style="display: none;"><label class="form-label">Descreva quais procedimentos</label><textarea name="invasivo_descricao" class="form-control" rows="2" placeholder="Aplicação de Substancias/ cortes, remoção de sinais. etc?"></textarea></div>
            </div>
        </div>

        <!-- Documentos -->
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">5. Documentos Anexados</h6></div>
            <div class="card-body">
                <div class="row mb-2 align-items-center"><div class="col-md-6"><label class="form-label mb-0">Alvará de Funcionamento (Prefeitura)</label></div><div class="col-md-6"><input class="form-control" type="file" name="doc_alvara_funcionamento"></div></div>
                <div class="row mb-2 align-items-center"><div class="col-md-6"><label class="form-label mb-0">Documento de identidade (RG ou CNH)</label></div><div class="col-md-6"><input class="form-control" type="file" name="doc_identidade"></div></div>
                <div class="row mb-2 align-items-center"><div class="col-md-6"><label class="form-label mb-0">CPF</label></div><div class="col-md-6"><input class="form-control" type="file" name="doc_cpf"></div></div>
                <div class="row mb-2 align-items-center"><div class="col-md-6"><label class="form-label mb-0">Comprovante de residência</label></div><div class="col-md-6"><input class="form-control" type="file" name="doc_residencia"></div></div>
                <div class="row mb-2 align-items-center"><div class="col-md-6"><label class="form-label mb-0">Comprovante de formação ou certificado</label></div><div class="col-md-6"><input class="form-control" type="file" name="doc_formacao"></div></div>
                <div class="row mb-2 align-items-center"><div class="col-md-6"><label class="form-label mb-0">Comprovante de dedetização</label></div><div class="col-md-6"><input class="form-control" type="file" name="doc_dedetizacao"></div></div>
            </div>
        </div>

        <!-- Declarações -->
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">6. Declarações</h6></div>
            <div class="card-body">
                <div class="form-check"><input class="form-check-input" type="checkbox" name="decl_verdade" required><label class="form-check-label">Declaro que as informações prestadas são verdadeiras.</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" name="decl_normas" required><label class="form-check-label">Declaro que tenho conhecimento das normas sanitárias vigentes.</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" name="decl_compromisso" required><label class="form-check-label">Declaro que me comprometo a manter o local em condições sanitárias adequadas.</label></div>
            </div>
        </div>

        <button type="submit" class="btn btn-success btn-lg w-100">Enviar Solicitação</button>
    </form>
    {% elif request.method == 'POST' %}
    <div class="alert alert-warning mt-4">Nenhum autônomo aprovado foi encontrado com o CPF informado.</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function setupConditionalDisplay(radioName, targetDivId) {
        const radios = document.querySelectorAll(`input[name="${radioName}"]`);
        const targetDiv = document.getElementById(targetDivId);
        
        const toggleVisibility = () => {
            const selected = document.querySelector(`input[name="${radioName}"]:checked`);
            if (selected && selected.value === 'sim') {
                targetDiv.style.display = 'block';
            } else {
                targetDiv.style.display = 'none';
            }
        };

        radios.forEach(radio => radio.addEventListener('change', toggleVisibility));
        toggleVisibility(); // Run on page load
    }

    setupConditionalDisplay('possui_rt', 'rt-div');
    setupConditionalDisplay('faz_invasivo', 'invasivo-div');
});
</script>
{% endblock %}
