{% extends 'admin_base.html' %}

{% block title %}Cadastrar Novo Lote de Receituário - VISA Digital{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-gray-800">Cadastrar Novo Lote de Receituário</h2>
        <a href="{{ url_for('admin_estoque_receituario') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para o Estoque
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Informações do Lote</h6>
        </div>
        <div class="card-body">
            <form id="form-cadastro-lote" method="POST" action="{{ url_for('admin_cadastrar_lote_receituario') }}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="tipo_receituario" class="form-label">Tipo de Receituário</label>
                        <select class="form-select" id="tipo_receituario" name="tipo_receituario" required>
                            <option value="">Selecione o Tipo</option>
                            {% for tipo in tipos_receituario %}
                            <option value="{{ tipo.id }}" data-sigla="{{ tipo.sigla }}" data-folhas-por-bloco="{{ tipo.folhas_por_bloco }}">{{ tipo.nome }} ({{ tipo.sigla }})</option>
                            {% endfor %}
                        </select>
                        {% if not tipos_receituario %}
                            <small class="form-text text-muted">Nenhum tipo de receituário cadastrado. Por favor, cadastre os tipos primeiro (necessário inserir manualmente no DB ou criar uma interface para isso).</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="data_entrada_estoque" class="form-label">Data de Entrada no Estoque</label>
                        <input type="date" class="form-control" id="data_entrada_estoque" name="data_entrada_estoque" required value="{{ today_date }}">
                    </div>
                </div>

                <hr class="my-4">

                {# SEÇÃO PARA RECEITUÁRIOS COM NUMERAÇÃO INDIVIDUAL DE PÁGINAS (A, B1, B2) #}
                <div id="secao-numerado">
                    <h4>Blocos a Cadastrar (Com Numeração de Páginas):</h4>
                    <div id="blocos-container">
                        <div class="bloco-item border p-3 mb-3 rounded bg-light">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="numero_bloco_0" class="form-label">Número do Bloco</label>
                                    <input type="text" class="form-control" id="numero_bloco_0" name="numero_bloco[]" placeholder="Ex: 001, B2-050" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="numero_inicial_0" class="form-label">Número Inicial (Folha)</label>
                                    <input type="number" class="form-control" id="numero_inicial_0" name="numero_inicial[]" min="1" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="numero_final_0" class="form-label">Número Final (Folha)</label>
                                    <input type="number" class="form-control" id="numero_final_0" name="numero_final[]" min="1" required>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-danger btn-sm remover-bloco" style="display: none;">Remover Bloco</button>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" id="adicionar-bloco" class="btn btn-info mt-3"><i class="fas fa-plus me-2"></i>Adicionar Novo Bloco</button>
                    </div>
                </div>

                {# SEÇÃO PARA RECEITUÁRIO DE CONTROLE ESPECIAL (C) #}
                <div id="secao-nao-numerado" style="display: none;">
                    <h4>Blocos a Cadastrar (Controle Especial - Sem Numeração de Páginas):</h4>
                    <p class="text-muted">O sistema irá gerar a numeração sequencial dos blocos. A quantidade de folhas por bloco pode ser editada.</p>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="quantidade_blocos_chegou" class="form-label">Quantidade de Blocos Recebidos</label>
                            <input type="number" class="form-control" id="quantidade_blocos_chegou" name="quantidade_blocos_chegou" min="1" placeholder="Ex: 10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="folhas_por_bloco_c" class="form-label">Folhas por Bloco</label>
                            <input type="number" class="form-control" id="folhas_por_bloco_c" name="folhas_por_bloco_c" min="1" placeholder="Ex: 100">
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg mt-3">Cadastrar Lote</button>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tipoReceituarioSelect = document.getElementById('tipo_receituario');
            const secaoNumerado = document.getElementById('secao-numerado');
            const secaoNaoNumerado = document.getElementById('secao-nao-numerado');
            const quantidadeBlocosChegouInput = document.getElementById('quantidade_blocos_chegou');
            const folhasPorBlocoNaoNumeradoInput = document.getElementById('folhas_por_bloco_c');

            const blocosContainer = document.getElementById('blocos-container');
            const adicionarBlocoBtn = document.getElementById('adicionar-bloco');
            let blocoIndex = 0;

            function setTodayDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                document.getElementById('data_entrada_estoque').value = `${year}-${month}-${day}`;
            }

            function updateRemoveButtons() {
                const removeButtons = document.querySelectorAll('.remover-bloco');
                if (removeButtons.length > 1) {
                    removeButtons.forEach(btn => btn.style.display = 'block');
                } else {
                    removeButtons.forEach(btn => btn.style.display = 'none');
                }
            }

            function adicionarNovoBloco() {
                blocoIndex++;
                const novoBlocoItem = document.querySelector('.bloco-item').cloneNode(true);
                
                novoBlocoItem.querySelectorAll('input').forEach(input => {
                    input.id = input.id.replace(/_\d+$/, `_${blocoIndex}`);
                    input.value = '';
                    input.required = true;
                });
                
                const removerBtn = novoBlocoItem.querySelector('.remover-bloco');
                removerBtn.style.display = 'block';
                removerBtn.addEventListener('click', function() {
                    novoBlocoItem.remove();
                    updateRemoveButtons();
                });

                blocosContainer.appendChild(novoBlocoItem);
                updateRemoveButtons();
            }

            adicionarBlocoBtn.addEventListener('click', adicionarNovoBloco);

            document.querySelector('.bloco-item .remover-bloco').addEventListener('click', function() {
                if (document.querySelectorAll('.bloco-item').length > 1) {
                    this.closest('.bloco-item').remove();
                    updateRemoveButtons();
                }
            });


            // Lógica para alternar seções com base no tipo de receituário
            function toggleSecoesReceituario() { // Nome CORRETO da função
                const selectedOption = tipoReceituarioSelect.options[tipoReceituarioSelect.selectedIndex];
                const sigla = selectedOption.dataset.sigla;
                const folhasPorBloco = selectedOption.dataset.folhasPorBloco;

                if (sigla === 'C') { // Se for Receituário de Controle Especial
                    secaoNumerado.style.display = 'none';
                    secaoNumerado.querySelectorAll('input').forEach(input => {
                        input.disabled = true;
                        input.required = false;
                        input.value = '';
                    });
                    
                    secaoNaoNumerado.style.display = 'block';
                    quantidadeBlocosChegouInput.disabled = false;
                    quantidadeBlocosChegouInput.required = true;
                    
                    folhasPorBlocoNaoNumeradoInput.value = folhasPorBloco; 
                    folhasPorBlocoNaoNumeradoInput.disabled = false; 
                    folhasPorBlocoNaoNumeradoInput.required = true; 
                } else { // Para outros tipos (A, B1, B2)
                    secaoNumerado.style.display = 'block';
                    secaoNumerado.querySelectorAll('input').forEach(input => {
                        if (input.name.includes('numero_bloco') || input.name.includes('numero_inicial') || input.name.includes('numero_final')) {
                            input.required = true;
                        }
                        input.disabled = false;
                    });

                    secaoNaoNumerado.style.display = 'none';
                    quantidadeBlocosChegouInput.disabled = true;
                    quantidadeBlocosChegouInput.required = false;
                    quantidadeBlocosChegouInput.value = '';
                    
                    folhasPorBlocoNaoNumeradoInput.disabled = true; 
                    folhasPorBlocoNaoNumeradoInput.required = false;
                    folhasPorBlocoNaoNumeradoInput.value = '';
                }
                updateRemoveButtons();
            }

            tipoReceituarioSelect.addEventListener('change', toggleSecoesReceituario);

            setTodayDate();
            updateRemoveButtons();
            // AQUI ESTAVA O ERRO DE DIGITAÇÃO!
            toggleSecoesReceituario(); // Chama a função CORRETA ao carregar para garantir o estado inicial
        });
    </script>
{% endblock %}
{% endblock %}