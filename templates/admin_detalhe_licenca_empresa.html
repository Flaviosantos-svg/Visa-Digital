{% extends 'admin_base.html' %}
{% block title %}Analisar Licença de Empresa{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Análise de Licença - Empresa</h1>
        <a href="{{ url_for('admin_analisar_licencas') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para a Lista
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Análise e Ações da Licença</h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin_atualizar_status_licenca_empresa', licenca_id=licenca.id) }}">
                <h5>Análise de Status</h5>
                <p>
                    <strong>Status atual:</strong>
                    <span class="badge
                        {% if licenca.status == 'Aprovada' %} bg-success
                        {% elif licenca.status == 'Reprovada' %} bg-danger
                        {% else %} bg-warning text-dark
                        {% endif %}">
                        {{ licenca.status }}
                    </span>
                </p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="novo_status" class="form-label">Mudar status para:</label>
                        <select class="form-select" name="novo_status" id="novo_status">
                            <option value="Aprovada">Aprovado</option>
                            <option value="Reprovada">Reprovado</option>
                            <option value="Pendente com Observação">Pendente com Observação</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="data_validade" class="form-label">Data de Validade:</label>
                        <input type="date" class="form-control" name="data_validade" id="data_validade" value="{{ licenca.data_validade.strftime('%Y-%m-%d') if licenca.data_validade else licenca.ano_exercicio ~ '-12-31' }}">
                    </div>
                    <div class="col-12">
                        <label for="observacoes" id="label_observacoes" class="form-label">Observações / Justificativa (visível para o cidadão):</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3">{{ licenca.observacoes or '' }}</textarea>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar Status
                    </button>
                    {% if licenca.status == 'Aprovada' %}
                        <a href="{{ url_for('admin_gerar_alvara_final', licenca_id=licenca.id) }}" class="btn btn-success" target="_blank">
                            <i class="fas fa-check-circle me-1"></i> Gerar e Imprimir Alvará
                        </a>
                    {% endif %}
                    <a href="{{ url_for('imprimir_ficha_licenca_empresa', licenca_id=licenca.id) }}" class="btn btn-info" target="_blank">
                        <i class="fas fa-print me-1"></i> Imprimir Ficha de Solicitação
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Histórico de Pendências e Respostas</h6>
        </div>
        <div class="card-body">
            {% if licenca.observacoes %}
                <h6>Observações da Vigilância / Respostas do Cidadão:</h6>
                <pre class="p-3 bg-light border rounded"><code>{{ licenca.observacoes }}</code></pre>
            {% endif %}

            {% if licenca.anexos_pendencia %}
                <h6 class="mt-4">Documentos Anexados para Resolução de Pendências:</h6>
                <ul class="list-group">
                    {% for anexo in licenca.anexos_pendencia %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-paperclip me-2"></i>
                            {{ anexo.nome_original }}
                            <small class="text-muted d-block">Enviado em: {{ anexo.data_envio }}</small>
                        </span>
                        <a href="{{ url_for('static', filename='uploads/' + anexo.caminho_salvo.replace('\\', '/')) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="fas fa-eye me-1"></i> Visualizar
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                {% if not licenca.observacoes %}
                     <p class="text-muted">Nenhum histórico de pendências para esta licença.</p>
                {% else %}
                     <p class="text-muted mt-3">Nenhum documento de pendência foi enviado pelo cidadão.</p>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Dados Cadastrais da Empresa</h6>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Protocolo:</dt><dd class="col-sm-9">{{ licenca.protocolo }}</dd>
                <dt class="col-sm-3">Razão Social:</dt><dd class="col-sm-9">{{ licenca.empresa.razao_social }}</dd>
                <dt class="col-sm-3">Nome Fantasia:</dt><dd class="col-sm-9">{{ licenca.empresa.nome_fantasia }}</dd>
                <dt class="col-sm-3">CNPJ:</dt><dd class="col-sm-9">{{ licenca.empresa.cnpj }}</dd>
                <dt class="col-sm-3">Endereço:</dt><dd class="col-sm-9">{{ licenca.empresa.endereco }}</dd>
            </dl>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Respostas do Questionário</h6>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-4">Ano de Exercício:</dt>
                <dd class="col-sm-8">{{ licenca.ano_exercicio }}</dd>
                <dt class="col-sm-4">Tipo de Atividade:</dt>
                <dd class="col-sm-8">{{ licenca.tipo_atividade }}</dd>
                <dt class="col-sm-4">Descrição da Atividade Principal:</dt>
                <dd class="col-sm-8">{{ licenca.descricao_atividade or 'Não informado' }}</dd>
                <hr class="my-3">
                <dt class="col-sm-4">Possui Local Físico:</dt>
                <dd class="col-sm-8">{{ licenca.possui_local_fisico | capitalize }}</dd>
                {% if licenca.possui_local_fisico == 'sim' %}
                    <dt class="col-sm-4 text-muted ps-5">Endereço do Local:</dt>
                    <dd class="col-sm-8 text-muted">{{ licenca.endereco_completo or 'Não informado' }}</dd>
                {% endif %}
                <dt class="col-sm-4">Necessita de Responsável Técnico (RT):</dt>
                <dd class="col-sm-8">{{ 'Sim' if licenca.necessita_rt == 'sim' else 'Não' }}</dd>
                {% if licenca.necessita_rt == 'sim' %}
                    <dt class="col-sm-4 text-muted ps-5">Nome do RT:</dt>
                    <dd class="col-sm-8 text-muted">{{ licenca.rt_nome or 'Não informado' }}</dd>
                    <dt class="col-sm-4 text-muted ps-5">CPF do RT:</dt>
                    <dd class="col-sm-8 text-muted">{{ licenca.rt_cpf or 'Não informado' }}</dd>
                    <dt class="col-sm-4 text-muted ps-5">Conselho:</dt>
                    <dd class="col-sm-8 text-muted">
                        {% if licenca.rt_conselho %}{{ licenca.rt_conselho }}{% if licenca.rt_numero_conselho %}: {{ licenca.rt_numero_conselho }}{% endif %}{% else %}Não informado{% endif %}
                    </dd>
                {% endif %}
                <dt class="col-sm-4">Vende Medicamentos Controlados:</dt>
                <dd class="col-sm-8">{{ licenca.vende_controlados | capitalize }}</dd>
                {% if licenca.vende_controlados == 'sim' %}
                    <dt class="col-sm-4 text-muted ps-5">Nº AFE:</dt>
                    <dd class="col-sm-8 text-muted">{{ licenca.afe_numero or 'Não informado' }}</dd>
                {% endif %}
                <dt class="col-sm-4">Vende Retinóicos:</dt>
                <dd class="col-sm-8">{{ licenca.vende_retinoicos | capitalize }}</dd>
                {% if licenca.vende_retinoicos == 'sim' %}
                    <dt class="col-sm-4 text-muted ps-5">Nº Autorização:</dt><dd class="col-sm-8 text-muted">{{ licenca.retinoicos_numero_autorizacao or 'Não informado' }}</dd>
                    <dt class="col-sm-4 text-muted ps-5">Data da Autorização:</dt><dd class="col-sm-8 text-muted">{{ licenca.retinoicos_data_autorizacao.strftime('%d/%m/%Y') if licenca.retinoicos_data_autorizacao else 'N/A' }}</dd>
                    <dt class="col-sm-4 text-muted ps-5">Data de Validade:</dt><dd class="col-sm-8 text-muted">{{ licenca.retinoicos_validade.strftime('%d/%m/%Y') if licenca.retinoicos_validade else 'N/A' }}</dd>
                {% endif %}
                <dt class="col-sm-4">Vende Animais Vivos:</dt>
                <dd class="col-sm-8">{{ licenca.vende_animais | capitalize }}</dd>
                {% if licenca.vende_animais == 'sim' %}
                    <dt class="col-sm-4 text-muted ps-5">Nome do RT Veterinário:</dt><dd class="col-sm-8 text-muted">{{ licenca.rt_vet_nome or 'Não informado' }}</dd>
                    <dt class="col-sm-4 text-muted ps-5">CPF do RT Veterinário:</dt><dd class="col-sm-8 text-muted">{{ licenca.rt_vet_cpf or 'Não informado' }}</dd>
                    <dt class="col-sm-4 text-muted ps-5">Nº CRMV:</dt><dd class="col-sm-8 text-muted">{{ licenca.rt_vet_crmv or 'Não informado' }}</dd>
                {% endif %}
                <dt class="col-sm-4">Realizou Dedetização:</dt>
                <dd class="col-sm-8">{{ licenca.realizou_dedetizacao | capitalize }}</dd>
                {% if licenca.realizou_dedetizacao == 'sim' %}
                    <dt class="col-sm-4 text-muted ps-5">Data da Dedetização:</dt>
                    <dd class="col-sm-8 text-muted">{{ licenca.dedetizacao_data.strftime('%d/%m/%Y') if licenca.dedetizacao_data else 'N/A' }}</dd>
                {% endif %}

                <hr class="my-3">
                <dt class="col-sm-4">É Microempreendedor Individual (MEI):</dt>
                <dd class="col-sm-8">{{ 'Sim' if licenca.e_mei == 'sim' else 'Não' }}</dd>

            </dl>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Documentos Anexados na Solicitação Inicial</h6>
        </div>
        <div class="card-body">
            {% set has_docs = False %}
            <ul class="list-group list-group-flush">
                {% if licenca.rt_declaracao_path %}
                    {% set has_docs = True %}
                    <li class="list-group-item"><i class="fas fa-file-pdf text-danger me-2"></i><a href="{{ url_for('static', filename='uploads/' + licenca.rt_declaracao_path.replace('\\', '/')) }}" target="_blank">Declaração de Responsável Técnico (RT)</a></li>
                {% endif %}
                {% if licenca.afe_anexo_path %}
                    {% set has_docs = True %}
                    <li class="list-group-item"><i class="fas fa-file-pdf text-danger me-2"></i><a href="{{ url_for('static', filename='uploads/' + licenca.afe_anexo_path.replace('\\', '/')) }}" target="_blank">Autorização de Funcionamento de Empresa (AFE)</a></li>
                {% endif %}
                {% if licenca.retinoicos_anexo_path %}
                    {% set has_docs = True %}
                    <li class="list-group-item"><i class="fas fa-file-pdf text-danger me-2"></i><a href="{{ url_for('static', filename='uploads/' + licenca.retinoicos_anexo_path.replace('\\', '/')) }}" target="_blank">Autorização para Venda de Retinóicos</a></li>
                {% endif %}
                {% if licenca.rt_vet_declaracao_path %}
                    {% set has_docs = True %}
                    <li class="list-group-item"><i class="fas fa-file-pdf text-danger me-2"></i><a href="{{ url_for('static', filename='uploads/' + licenca.rt_vet_declaracao_path.replace('\\', '/')) }}" target="_blank">Declaração de RT (Veterinário)</a></li>
                {% endif %}
                {% if licenca.dedetizacao_anexo_path %}
                    {% set has_docs = True %}
                    <li class="list-group-item"><i class="fas fa-file-pdf text-danger me-2"></i><a href="{{ url_for('static', filename='uploads/' + licenca.dedetizacao_anexo_path.replace('\\', '/')) }}" target="_blank">Certificado de Dedetização</a></li>
                {% endif %}
                {% if licenca.comprovante_taxa_path %}
                    {% set has_docs = True %}
                    <li class="list-group-item"><i class="fas fa-file-pdf text-danger me-2"></i><a href="{{ url_for('static', filename='uploads/' + licenca.comprovante_taxa_path.replace('\\', '/')) }}" target="_blank">Comprovante de Pagamento de Taxa</a></li>
                {% endif %}
            </ul>
            {% if not has_docs %}
                <p class="text-muted">Nenhum documento foi anexado na solicitação inicial.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('novo_status');
    const observacoesTextarea = document.getElementById('observacoes');
    const observacoesLabel = document.getElementById('label_observacoes');
    const originalLabel = observacoesLabel.innerHTML;

    function toggleObservacoesRequired() {
        const selectedValue = statusSelect.value;
        if (selectedValue === 'Reprovada' || selectedValue === 'Pendente com Observação') {
            observacoesTextarea.required = true;
            observacoesLabel.innerHTML = originalLabel + ' <span class="text-danger">*</span>';
        } else {
            observacoesTextarea.required = false;
            observacoesLabel.innerHTML = originalLabel;
        }
    }

    // Adiciona o listener para o evento de mudança
    statusSelect.addEventListener('change', toggleObservacoesRequired);

    // Executa a função uma vez no carregamento da página para definir o estado inicial
    toggleObservacoesRequired();
});
</script>
{% endblock %}