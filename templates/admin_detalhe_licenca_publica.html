{% extends 'admin_base.html' %}
{% block title %}Analisar Licença Pública{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    {# --- CORREÇÃO APLICADA: 'licença' alterado para 'licenca' --- #}
    <h1 class="h3 mb-0 text-gray-800">Análise de Licença Pública - Protocolo {{ licenca.protocolo_licencas_publicas }}</h1>
    <a href="{{ url_for('admin_listar_licencas_publicas') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i> Voltar para a Lista
    </a>
</div>

<div class="row">
    <!-- Coluna da Esquerda: Detalhes da Solicitação -->
    <div class="col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">1. Dados da Instituição</h6></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Razão Social:</dt><dd class="col-sm-8">{{ licenca.empresa.razao_social if licenca.empresa else 'N/A' }}</dd>
                    <dt class="col-sm-4">CNPJ:</dt><dd class="col-sm-8">{{ licenca.empresa.cnpj if licenca.empresa else 'N/A' }}</dd>
                </dl>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">2. Dados da Unidade</h6></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Nome da Unidade:</dt><dd class="col-sm-8">{{ licenca.unidade_nome }}</dd>
                    <dt class="col-sm-4">CNES/INEP:</dt><dd class="col-sm-8">{{ licenca.unidade_cnes_inep or 'Não informado' }}</dd>
                    <dt class="col-sm-4">Endereço:</dt><dd class="col-sm-8">{{ licenca.unidade_endereco }}</dd>
                    <dt class="col-sm-4">Ponto de Referência:</dt><dd class="col-sm-8">{{ licenca.unidade_ponto_ref }}</dd>
                    <dt class="col-sm-4">Tipo de Unidade:</dt><dd class="col-sm-8">{{ licenca.unidade_tipo_outro or licenca.unidade_tipo }}</dd>
                </dl>
            </div>
        </div>
        
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">3. Dados do Responsável pela Unidade</h6></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Nome:</dt><dd class="col-sm-8">{{ licenca.responsavel_unidade_nome }}</dd>
                    <dt class="col-sm-4">CPF:</dt><dd class="col-sm-8">{{ licenca.responsavel_unidade_cpf }}</dd>
                    <dt class="col-sm-4">Cargo/Função:</dt><dd class="col-sm-8">{{ licenca.responsavel_unidade_cargo }}</dd>
                    <dt class="col-sm-4">Conselho Profissional:</dt><dd class="col-sm-8">{{ licenca.responsavel_unidade_conselho or 'Não se aplica' }}</dd>
                    <dt class="col-sm-4">Contato:</dt><dd class="col-sm-8">{{ licenca.responsavel_unidade_contato }}</dd>
                </dl>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">4. Atividades e Anexos</h6></div>
            <div class="card-body">
                <h6>Atividades Desenvolvidas:</h6>
                <p class="text-muted">{{ licenca.atividades_desenvolvidas }}</p>
                <hr>
                <h6>Serviços Prestados:</h6>
                <p class="text-muted">{{ licenca.servicos_prestados }}</p>
                <hr>
                <h6>Anexos da Solicitação Original:</h6>
                <ul>
                    {% if licenca.responsavel_unidade_declaracao_rt_path %}
                        <li><a href="{{ url_for('static', filename='uploads/' + licenca.responsavel_unidade_declaracao_rt_path) }}" target="_blank">Declaração de RT da Unidade</a></li>
                    {% endif %}
                    {% if licenca.anexo_declaracao_responsavel_path %}
                        <li><a href="{{ url_for('static', filename='uploads/' + licenca.anexo_declaracao_responsavel_path) }}" target="_blank">Declaração do Responsável pela Instituição</a></li>
                    {% endif %}
                    {% if licenca.anexo_declaracao_rt_geral_path %}
                        <li><a href="{{ url_for('static', filename='uploads/' + licenca.anexo_declaracao_rt_geral_path) }}" target="_blank">Declaração de RT Geral</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Coluna da Direita: Ações do Administrador -->
    <div class="col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">5. Análise e Ações</h6></div>
            <div class="card-body">
                <form action="{{ url_for('admin_atualizar_status_licenca_publica', licenca_id=licenca.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="status" class="form-label fw-bold">Alterar Status:</label>
                        <select name="status" id="status" class="form-select">
                            <option value="Em Análise" {% if licenca.status == 'Em Análise' %}selected{% endif %}>Em Análise</option>
                            <option value="Em Análise (Resposta Recebida)" {% if licenca.status == 'Em Análise (Resposta Recebida)' %}selected{% endif %}>Em Análise (Resposta Recebida)</option>
                            <option value="Pendente com Observação" {% if licenca.status == 'Pendente com Observação' %}selected{% endif %}>Pendente com Observação</option>
                            <option value="Aprovado" {% if licenca.status == 'Aprovado' %}selected{% endif %}>Aprovado</option>
                            <option value="Reprovado" {% if licenca.status == 'Reprovado' %}selected{% endif %}>Reprovado</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações / Motivo:</label>
                        <textarea name="observacoes" id="observacoes" class="form-control" rows="5" placeholder="Se necessário, adicione aqui observações, pendências ou o motivo da reprovação.">{{ licenca.observacoes or '' }}</textarea>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save me-2"></i> Salvar Análise
                    </button>
                </form>

                {% if licenca.status == 'Aprovado' %}
                <hr>
                <div class="mt-3 text-center">
                    <a href="{{ url_for('imprimir_alvara_publica_cidadao', licenca_id=licenca.id) }}" target="_blank" class="btn btn-success">
                        <i class="fas fa-print me-2"></i>Imprimir Alvará
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Card de Histórico de Pendências e Respostas -->
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-info">Histórico de Pendências e Respostas</h6></div>
            <div class="card-body">
                {% if licenca.resposta_pendencia_texto or licenca.anexo_pendencia_path %}
                    {% if licenca.resposta_pendencia_texto %}
                        <h6>Resposta do Solicitante:</h6>
                        <p class="text-muted fst-italic bg-light p-2 rounded">"{{ licenca.resposta_pendencia_texto }}"</p>
                    {% endif %}
                    
                    {% if licenca.anexo_pendencia_path %}
                        <hr>
                        <h6>Anexo da Resposta:</h6>
                        <a href="{{ url_for('static', filename='uploads/' + licenca.anexo_pendencia_path) }}" target="_blank" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-file-download me-2"></i> Visualizar anexo enviado
                        </a>
                    {% endif %}
                {% else %}
                    <p class="text-muted mb-0">Nenhum histórico de pendências para esta licença.</p>
                {% endif %}
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('status');
    const observacoesTextarea = document.getElementById('observacoes');
    const observacoesLabel = document.querySelector('label[for="observacoes"]');
    const originalLabelText = observacoesLabel.textContent;

    function toggleObservationRequirement() {
        const statusValue = statusSelect.value;
        if (statusValue === 'Pendente com Observação' || statusValue === 'Reprovado') {
            observacoesTextarea.required = true;
            observacoesLabel.innerHTML = originalLabelText + ' <span class="text-danger">*</span>';
            observacoesTextarea.placeholder = 'O motivo é obrigatório para este status.';
        } else {
            observacoesTextarea.required = false;
            observacoesLabel.innerHTML = originalLabelText;
            observacoesTextarea.placeholder = 'Se necessário, adicione aqui observações...';
        }
    }

    // Verifica o estado inicial quando a página carrega
    toggleObservationRequirement();

    // Adiciona o listener para mudanças no select
    statusSelect.addEventListener('change', toggleObservationRequirement);
});
</script>
{% endblock %}
