{% extends 'admin_base.html' %}
{% block title %}Ficha Cadastral - {{ empresa.razao_social }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Ficha Cadastral da Empresa</h1>
        <div>
            <a href="{{ url_for('admin_empresas_cadastradas') }}" class="btn btn-secondary">Voltar</a>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Dados Principais</h6>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Protocolo:</dt><dd class="col-sm-9">{{ empresa.protocolo }}</dd>
                <dt class="col-sm-3">Razão Social:</dt><dd class="col-sm-9">{{ empresa.razao_social }}</dd>
                <dt class="col-sm-3">Nome Fantasia:</dt><dd class="col-sm-9">{{ empresa.nome_fantasia }}</dd>
                <dt class="col-sm-3">CNPJ:</dt><dd class="col-sm-9">{{ empresa.cnpj }}</dd>
                <dt class="col-sm-3">CNAE Primário:</dt><dd class="col-sm-9">{{ empresa.cnae_principal }}</dd>
                <dt class="col-sm-3">CNAE Secundário:</dt><dd class="col-sm-9">{{ empresa.cnae_secundario }}</dd>
                <dt class="col-sm-3">Endereço:</dt><dd class="col-sm-9">{{ empresa.endereco }}</dd>
                <dt class="col-sm-3">Telefone:</dt><dd class="col-sm-9">{{ empresa.telefone_empresa or 'Não informado' }}</dd>
                <dt class="col-sm-3">Responsável Jurídico:</dt><dd class="col-sm-9">{{ empresa.responsavel_juridico_nome }}</dd>
                <dt class="col-sm-3">Horário de Funcionamento:</dt><dd class="col-sm-9">{{ empresa.horario_segunda_feira or 'Não informado' }}</dd>
            </dl>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="licencas-tab" data-bs-toggle="tab" data-bs-target="#licencas" type="button" role="tab" aria-controls="licencas" aria-selected="true">Licenças</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="vistorias-tab" data-bs-toggle="tab" data-bs-target="#vistorias" type="button" role="tab" aria-controls="vistorias" aria-selected="false">Vistorias</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="denuncias-tab" data-bs-toggle="tab" data-bs-target="#denuncias" type="button" role="tab" aria-controls="denuncias" aria-selected="false">Denúncias</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notificacoes-tab" data-bs-toggle="tab" data-bs-target="#notificacoes" type="button" role="tab" aria-controls="notificacoes" aria-selected="false">Notificações</button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="licencas" role="tabpanel" aria-labelledby="licencas-tab">
                    {% if empresa.licencas %}
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Protocolo</th>
                                        <th>Ano</th>
                                        <th>Data da Solicitação</th>
                                        <th>Status</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for licenca in empresa.licencas|sort(attribute='data_solicitacao', reverse=true) %}
                                    <tr>
                                        <td>{{ licenca.protocolo }}</td>
                                        <td>{{ licenca.ano_exercicio }}</td>
                                        <td>{{ licenca.data_solicitacao.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            <span class="badge 
                                                {% if licenca.status == 'Aprovada' %} bg-success
                                                {% elif licenca.status == 'Reprovada' %} bg-danger
                                                {% elif licenca.status == 'Pendente com Observação' %} bg-warning text-dark
                                                {% else %} bg-secondary
                                                {% endif %}">
                                                {{ licenca.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('admin_detalhe_licenca_empresa', licenca_id=licenca.id) }}" class="btn btn-sm btn-outline-primary">Ver Detalhes</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">Nenhum histórico de licenças para esta empresa.</p>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="vistorias" role="tabpanel" aria-labelledby="vistorias-tab">
                    <p class="text-muted text-center">Histórico de vistorias aparecerá aqui.</p>
                </div>

                <div class="tab-pane fade" id="denuncias" role="tabpanel" aria-labelledby="denuncias-tab">
                    {% if empresa.denuncias %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>Protocolo</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for denuncia in empresa.denuncias|sort(attribute='data_denuncia', reverse=true) %}
                                    <tr>
                                        <td>{{ denuncia.protocolo_denuncia }}</td>
                                        <td>{{ denuncia.data_denuncia.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            <span class="badge 
                                                {% if denuncia.status == 'Recebida' %}bg-primary
                                                {% elif denuncia.status == 'Em Análise' %}bg-warning text-dark
                                                {% elif denuncia.status == 'Atendida' %}bg-success
                                                {% else %}bg-secondary
                                                {% endif %}">
                                                {{ denuncia.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('admin_detalhe_denuncia', denuncia_id=denuncia.id) }}" class="btn btn-sm btn-outline-info">Ver Detalhes</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">Nenhuma denúncia vinculada a esta empresa.</p>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="notificacoes" role="tabpanel" aria-labelledby="notificacoes-tab">
                    <p class="text-muted text-center">Histórico de notificações aparecerá aqui.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}