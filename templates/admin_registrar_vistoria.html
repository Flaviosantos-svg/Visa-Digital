{% extends 'admin_base.html' %}

{% block title %}Registrar Nova Vistoria{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="h3 mb-4 text-gray-800">Registrar Nova Vistoria</h1>

    <!-- 1. Busca da Empresa -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">1. Identificação do Estabelecimento</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('registrar_vistoria') }}">
                <div class="input-group">
                    <input type="text" class="form-control" name="cnpj" placeholder="Buscar por CNPJ para preencher os dados..." value="{{ cnpj_buscado or '' }}">
                    <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>

    {% if empresa %}
    <form method="POST" action="{{ url_for('salvar_vistoria') }}">
        <input type="hidden" name="empresa_id" value="{{ empresa.id }}">

        <!-- 2. Dados da Empresa e da Vistoria -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Data da Vistoria:</label>
                        <input type="date" name="data_vistoria" class="form-control" required>
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Razão Social:</label>
                        <input type="text" class="form-control" value="{{ empresa.razao_social }}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nome Fantasia:</label>
                        <input type="text" class="form-control" value="{{ empresa.nome_fantasia or 'Não informado' }}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">CNPJ/CPF:</label>
                        <input type="text" class="form-control" value="{{ empresa.cnpj }}" readonly>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label">Endereço Completo:</label>
                        <input type="text" class="form-control" value="{{ empresa.endereco }}" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Telefone de Contato:</label>
                        <input type="text" class="form-control" value="{{ empresa.telefone_empresa }}" readonly>
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">E-mail:</label>
                        <input type="text" class="form-control" value="{{ empresa.email or 'Não informado' }}" readonly>
                    </div>
                     <div class="col-md-12 mb-3">
                        <label class="form-label fw-bold">Motivo da Vistoria:</label>
                        <div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="motivo_vistoria" value="Rotina"> Rotina</div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="motivo_vistoria" value="Solicitação de Licença"> Solicitação de Licença</div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="motivo_vistoria" value="Renovação de Licença"> Renovação de Licença</div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="motivo_vistoria" value="Verificação de Denúncia"> Verificação de Denúncia</div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="motivo_vistoria" value="Outros"> Outros</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Documentação -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">2. Documentação</h6>
            </div>
            <div class="card-body">
                <div class="form-check"><input class="form-check-input" type="checkbox" name="documentacao[]" value="Alvará de Localização"> Alvará de Localização e Funcionamento</div>
                <div class="form-check"><input class="form-check-input" type="checkbox" name="documentacao[]" value="Licença Sanitária"> Licença Sanitária (Alvará Sanitário)</div>
                <div class="form-check"><input class="form-check-input" type="checkbox" name="documentacao[]" value="POPs"> Procedimentos Operacionais Padronizados (POPs)</div>
                <div class="form-check"><input class="form-check-input" type="checkbox" name="documentacao[]" value="Controle de Pragas"> Comprovante de Controle de Pragas e Vetores</div>
                <div class="form-check"><input class="form-check-input" type="checkbox" name="documentacao[]" value="ASO"> Atestados de Saúde Ocupacional (ASO) dos funcionários</div>
                <div class="form-check"><input class="form-check-input" type="checkbox" name="documentacao[]" value="Capacitação"> Certificados de capacitação dos funcionários</div>
                <div class="form-check"><input class="form-check-input" type="checkbox" name="documentacao[]" value="Resíduos"> Contrato de recolhimento de resíduos (se aplicável)</div>
            </div>
        </div>

        <!-- 4. Roteiro de Inspeção -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">3. Roteiro de Inspeção (Checklist)</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="checklist_id" class="form-label">Selecione um checklist para aplicar:</label>
                    <select name="checklist_id" id="checklist_id" class="form-select">
                        <option value="">Nenhum checklist aplicado</option>
                        {% for cl in checklists %}
                            <option value="{{ cl.id }}">{{ cl.titulo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="checklist-container" class="mt-4"></div>
            </div>
        </div>

        <!-- 5. Considerações Finais (ATUALIZADO) -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">4. Considerações Finais e Encaminhamentos</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Observações e Recomendações:</label>
                    <div id="observacoes-container">
                        <!-- Observações dinâmicas serão inseridas aqui -->
                    </div>
                    <button type="button" id="add-observacao-btn" class="btn btn-sm btn-outline-secondary mt-2">
                        <i class="fas fa-plus me-1"></i> Adicionar Observação
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="prazo_adequacao" class="form-label">Prazo para Adequação:</label>
                        <input type="date" name="prazo_adequacao" id="prazo_adequacao" class="form-control">
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. Fiscais Sanitários (NOVO) -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">5. Fiscais Sanitários</h6>
            </div>
            <div class="card-body">
                <div id="fiscais-container">
                    <!-- Fiscais dinâmicos serão inseridos aqui -->
                </div>
                <button type="button" id="add-fiscal-btn" class="btn btn-sm btn-outline-secondary mt-2">
                    <i class="fas fa-plus me-1"></i> Adicionar Fiscal
                </button>
            </div>
            <div class="card-footer text-end">
                <button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i>Registrar Vistoria</button>
            </div>
        </div>
    </form>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Script do Checklist Dinâmico (sem alterações) ---
    const checklistsData = {{ checklists_json|tojson }};
    const checklistSelect = document.getElementById('checklist_id');
    const checklistContainer = document.getElementById('checklist-container');

    checklistSelect.addEventListener('change', function() {
        const selectedId = this.value;
        checklistContainer.innerHTML = ''; 

        if (!selectedId || !checklistsData[selectedId]) {
            return;
        }

        const checklist = checklistsData[selectedId].itens;
        let questionCounter = 0;

        if (checklist && checklist.sections) {
            checklist.sections.forEach((section, sectionIndex) => {
                const sectionTitle = document.createElement('h5');
                sectionTitle.className = 'mb-3 mt-4';
                sectionTitle.textContent = section.title;
                checklistContainer.appendChild(sectionTitle);

                section.questions.forEach((question, questionIndex) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'card mb-3';
                    
                    const questionTextHiddenInput = `<input type="hidden" name="pergunta_texto[]" value="${question.text}">`;
                    const uniqueName = `resposta_${questionCounter}`;

                    if (question.type === 'sim_nao_na') {
                        const buttonsHtml = `
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="${uniqueName}" id="q_${questionCounter}_sim" value="Sim">
                                <label class="btn btn-outline-success" for="q_${questionCounter}_sim">Sim</label>
                                
                                <input type="radio" class="btn-check" name="${uniqueName}" id="q_${questionCounter}_nao" value="Não">
                                <label class="btn btn-outline-danger" for="q_${questionCounter}_nao">Não</label>
                                
                                <input type="radio" class="btn-check" name="${uniqueName}" id="q_${questionCounter}_na" value="N/A" checked>
                                <label class="btn btn-outline-secondary" for="q_${questionCounter}_na">N/A</label>
                            </div>
                        `;
                        
                        questionDiv.innerHTML = `
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <p class="mb-0 me-3"><strong>${question.text}</strong></p>
                                    ${buttonsHtml}
                                </div>
                                ${questionTextHiddenInput}
                                <textarea name="observacao[]" class="form-control" rows="1" placeholder="Observações (opcional)"></textarea>
                            </div>
                        `;
                    } else { 
                        const inputHtml = `<textarea name="${uniqueName}" class="form-control" rows="2" placeholder="Descreva a conformidade..."></textarea>`;
                        questionDiv.innerHTML = `
                            <div class="card-body">
                                <p class="mb-2"><strong>${question.text}</strong></p>
                                ${questionTextHiddenInput}
                                <div class="mb-2">${inputHtml}</div>
                                <textarea name="observacao[]" class="form-control" rows="1" placeholder="Observações (opcional)"></textarea>
                            </div>
                        `;
                    }
                    checklistContainer.appendChild(questionDiv);
                    questionCounter++; 
                });
            });
        }
    });

    // --- NOVO SCRIPT para Observações Dinâmicas ---
    const observacoesContainer = document.getElementById('observacoes-container');
    const addObservacaoBtn = document.getElementById('add-observacao-btn');
    let observacaoCounter = 0;

    function addObservacao() {
        observacaoCounter++;
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <span class="input-group-text">${observacaoCounter}.</span>
            <input type="text" name="observacoes[]" class="form-control" placeholder="Descreva a observação...">
            <button class="btn btn-outline-danger remove-btn" type="button"><i class="fas fa-times"></i></button>
        `;
        observacoesContainer.appendChild(div);
    }
    addObservacaoBtn.addEventListener('click', addObservacao);
    addObservacao(); 

    // --- NOVO SCRIPT para Fiscais Dinâmicos ---
    const fiscaisContainer = document.getElementById('fiscais-container');
    const addFiscalBtn = document.getElementById('add-fiscal-btn');

    function addFiscal() {
        const div = document.createElement('div');
        div.className = 'row mb-2';
        div.innerHTML = `
            <div class="col-md-6">
                <input type="text" name="fiscais_nomes[]" class="form-control" placeholder="Nome do Fiscal">
            </div>
            <div class="col-md-5">
                <input type="text" name="fiscais_matriculas[]" class="form-control" placeholder="Matrícula">
            </div>
            <div class="col-md-1">
                <button class="btn btn-outline-danger remove-btn w-100" type="button"><i class="fas fa-times"></i></button>
            </div>
        `;
        fiscaisContainer.appendChild(div);
    }
    addFiscalBtn.addEventListener('click', addFiscal);
    addFiscal();

    // Event listener genérico para botões de remover
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-btn')) {
            e.target.closest('.input-group, .row').remove();
            renumerarObservacoes();
        }
    });

    function renumerarObservacoes() {
        const observacoes = observacoesContainer.querySelectorAll('.input-group');
        observacaoCounter = 0;
        observacoes.forEach((obs, index) => {
            observacaoCounter = index + 1;
            obs.querySelector('.input-group-text').textContent = `${observacaoCounter}.`;
        });
    }
});
</script>
{% endblock %}