{% extends 'admin_base.html' %}
{% block title %}Licença para Empresa{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <h1 class="h3 mb-4 text-gray-800">Solicitar Licença para Pessoa Jurídica</h1>
    
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Buscar Empresa por CNPJ</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('solicitar_licenca_cnpj') }}">
                <div class="input-group">
                    <input type="text" name="cnpj" class="form-control" placeholder="Digite o CNPJ para buscar..." value="{{ query_cnpj or '' }}" required>
                    <button class="btn btn-primary" type="submit"><i class="fas fa-search me-2"></i>Buscar</button>
                </div>
            </form>
        </div>
    </div>

    {% if empresa %}
    <form action="{{ url_for('salvar_licenca_empresa') }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="empresa_id" value="{{ empresa.id }}">

        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Dados Cadastrais da Empresa</h6></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Razão Social:</dt><dd class="col-sm-9">{{ empresa.razao_social }}</dd>
                    <dt class="col-sm-3">Nome Fantasia:</dt><dd class="col-sm-9">{{ empresa.nome_fantasia }}</dd>
                    <dt class="col-sm-3">CNPJ:</dt><dd class="col-sm-9">{{ empresa.cnpj }}</dd>
                    <dt class="col-sm-3">Situação Cadastral:</dt><dd class="col-sm-9">{{ empresa.situacao_cadastral }}</dd>
                    <dt class="col-sm-3">Endereço:</dt><dd class="col-sm-9">{{ empresa.endereco }}</dd>
                    <dt class="col-sm-3">Horário de Funcionamento:</dt><dd class="col-sm-9">{{ empresa.horario_segunda_feira }}</dd>
                </dl>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Questionário da Licença Sanitária</h6></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6 mb-3"><label class="form-label">Ano de Exercício</label><input type="number" name="ano_exercicio" class="form-control" value="{{ ano_atual }}" required></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Tipo de Atividade</label><select name="tipo_atividade" class="form-select" required><option value="">Selecione...</option><option>Saúde</option><option>Alimentação</option><option>Estética</option><option>Veterinária</option><option>Outros</option></select></div>
                </div>
                
                <div class="mb-3"><label class="form-label d-block">O Estabelecimento possui local físico?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="possui_local_fisico" id="local_sim" value="sim"><label class="form-check-label" for="local_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="possui_local_fisico" id="local_nao" value="nao" checked><label class="form-check-label" for="local_nao">Não</label></div></div>
                <div id="endereco-div" class="p-3 mb-3 border rounded bg-light" style="display: none;"><label class="form-label">Endereço Completo</label><input type="text" name="endereco_completo" class="form-control"></div>

                <div class="mb-3"><label class="form-label d-block">A empresa necessita de Responsável Técnico (RT)?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="necessita_rt" id="rt_sim" value="sim"><label class="form-check-label" for="rt_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="necessita_rt" id="rt_nao" value="nao" checked><label class="form-check-label" for="rt_nao">Não</label></div></div>
                <div id="rt-div" class="p-3 mb-3 border rounded bg-light" style="display: none;"><h6>Dados do RT</h6><div class="row"><div class="col-md-6"><input type="text" name="rt_nome" class="form-control mb-2" placeholder="Nome"></div><div class="col-md-6"><input type="text" name="rt_cpf" class="form-control mb-2" placeholder="CPF"></div><div class="col-md-6"><input type="text" name="rt_conselho" class="form-control mb-2" placeholder="Conselho de Classe"></div><div class="col-md-6"><input type="text" name="rt_numero_conselho" class="form-control mb-2" placeholder="Nº do Conselho"></div><div class="col-12"><label class="form-label small">Anexar Declaração de RT</label><input type="file" name="rt_declaracao" class="form-control"></div></div></div>
                
                <div class="mb-3"><label class="form-label d-block">Vende medicamentos controlados (Portaria 344/98)?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="vende_controlados" id="controlados_sim" value="sim"><label class="form-check-label" for="controlados_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="vende_controlados" id="controlados_nao" value="nao" checked><label class="form-check-label" for="controlados_nao">Não</label></div></div>
                <div id="afe-div" class="p-3 mb-3 border rounded bg-light" style="display: none;"><h6>Dados da AFE</h6><div class="row"><div class="col-md-6"><input type="text" name="afe_numero" class="form-control mb-2" placeholder="Nº da Autorização"></div><div class="col-md-6"><label class="form-label small">Anexar AFE</label><input type="file" name="afe_anexo" class="form-control"></div></div></div>

                <div class="mb-3"><label class="form-label d-block">Vende Retinóicos?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="vende_retinoicos" id="retinoicos_sim" value="sim"><label class="form-check-label" for="retinoicos_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="vende_retinoicos" id="retinoicos_nao" value="nao" checked><label class="form-check-label" for="retinoicos_nao">Não</label></div></div>
                <div id="retinoicos-div" class="p-3 mb-3 border rounded bg-light" style="display: none;"><h6>Autorização de Retinóicos</h6><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Número da Autorização</label><input type="text" name="retinoicos_numero_autorizacao" class="form-control" placeholder="Digite o número"></div><div class="col-md-6 mb-3"><label class="form-label">Data da Autorização</label><input type="date" name="retinoicos_data_autorizacao" class="form-control"></div><div class="col-md-6 mb-3"><label class="form-label">Data de Validade</label><input type="date" name="retinoicos_validade" class="form-control"></div><div class="col-md-6 mb-3"><label class="form-label">Anexar Autorização</label><input type="file" name="retinoicos_anexo" class="form-control"></div></div></div>
                
                <div class="mb-3"><label class="form-label d-block">Realiza a manipulação de medicamentos?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="realiza_manipulacao" id="manipulacao_sim" value="sim"><label class="form-check-label" for="manipulacao_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="realiza_manipulacao" id="manipulacao_nao" value="nao" checked><label class="form-check-label" for="manipulacao_nao">Não</label></div></div>
                
                <div class="mb-3"><label class="form-label d-block">Vende animais vivos?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="vende_animais" id="animais_sim" value="sim"><label class="form-check-label" for="animais_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="vende_animais" id="animais_nao" value="nao" checked><label class="form-check-label" for="animais_nao">Não</label></div></div>
                <div id="rt-vet-div" class="p-3 mb-3 border rounded bg-light" style="display: none;"><h6>Dados do RT Veterinário</h6><div class="row"><div class="col-md-6"><input type="text" name="rt_vet_nome" class="form-control mb-2" placeholder="Nome"></div><div class="col-md-6"><input type="text" name="rt_vet_cpf" class="form-control mb-2" placeholder="CPF"></div><div class="col-md-6"><input type="text" name="rt_vet_crmv" class="form-control mb-2" placeholder="Nº do CRMV"></div><div class="col-md-6"><label class="form-label small">Anexar Declaração de RT</label><input type="file" name="rt_vet_declaracao" class="form-control"></div></div></div>

                <div class="mb-3"><label class="form-label d-block">Realizou dedetização?</label><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="realizou_dedetizacao" id="dedetizacao_sim" value="sim"><label class="form-check-label" for="dedetizacao_sim">Sim</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="realizou_dedetizacao" id="dedetizacao_nao" value="nao" checked><label class="form-check-label" for="dedetizacao_nao">Não</label></div></div>
                <div id="dedetizacao-div" class="p-3 mb-3 border rounded bg-light" style="display: none;"><h6>Dados da Dedetização</h6><div class="row"><div class="col-md-6"><label class="form-label small">Data da Dedetização</label><input type="date" name="dedetizacao_data" class="form-control mb-2"></div><div class="col-md-6"><label class="form-label small">Anexar Certificado</label><input type="file" name="dedetizacao_anexo" class="form-control"></div></div></div>

                <!-- :: INÍCIO DA ALTERAÇÃO :: -->
                <div class="mb-3">
                    <label class="form-label d-block">A empresa é um Microempreendedor Individual (MEI)?</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="e_mei" id="mei_sim" value="sim" checked>
                        <label class="form-check-label" for="mei_sim">Sim</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="e_mei" id="mei_nao" value="nao">
                        <label class="form-check-label" for="mei_nao">Não</label>
                    </div>
                </div>
                <div id="taxa-div" class="p-3 mb-3 border rounded bg-light" style="display: none;">
                    <h6>Taxa Municipal</h6>
                    <label class="form-label small">Anexar Comprovante de Pagamento da Taxa</label>
                    <input type="file" name="comprovante_taxa" class="form-control">
                </div>
                <!-- :: FIM DA ALTERAÇÃO :: -->

                <div class="mb-3"><label class="form-label">Descrição da Atividade Principal</label><textarea name="descricao_atividade" class="form-control" rows="3" required></textarea></div>
                <hr>
                <div class="form-check mb-3"><input type="checkbox" class="form-check-input" id="declaracao" required><label class="form-check-label" for="declaracao">Declaro que as informações prestadas são verdadeiras.</label></div>
                <button type="submit" class="btn btn-success btn-lg w-100">Enviar Solicitação</button>
            </div>
        </div>
    </form>
    {% elif query_cnpj %}
    <div class="alert alert-warning">Nenhuma empresa aprovada encontrada com o CNPJ informado.</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function setupConditionalDisplay(radioName, targetDivId, showWhenValueIs = 'sim') {
        const radios = document.querySelectorAll(`input[name="${radioName}"]`);
        const targetDiv = document.getElementById(targetDivId);
        
        const toggleVisibility = () => {
            const selected = document.querySelector(`input[name="${radioName}"]:checked`);
            if (selected && selected.value === showWhenValueIs) {
                targetDiv.style.display = 'block';
            } else {
                targetDiv.style.display = 'none';
            }
        };

        radios.forEach(radio => radio.addEventListener('change', toggleVisibility));
        toggleVisibility();
    }

    setupConditionalDisplay('e_mei', 'taxa-div', 'nao');
    setupConditionalDisplay('possui_local_fisico', 'endereco-div');
    setupConditionalDisplay('necessita_rt', 'rt-div');
    setupConditionalDisplay('vende_controlados', 'afe-div');
    setupConditionalDisplay('vende_retinoicos', 'retinoicos-div');
    setupConditionalDisplay('vende_animais', 'rt-vet-div');
    setupConditionalDisplay('realizou_dedetizacao', 'dedetizacao-div');
});
</script>
{% endblock %}
